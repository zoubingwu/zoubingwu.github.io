<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=/assets/fonts/googlefont.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/assets/fonts/googlefont.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>Generator in JavaScript | https://zoubingwu.com</title><meta property=og:title content="Generator in JavaScript | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content="Let's talk about generator, coroutine, async/await and redux-saga..."><meta property=og:description content="Let's talk about generator, coroutine, async/await and redux-saga..."><link rel=canonical href=https://zoubingwu.com/2020-01-28/generator-in-javascript><meta property=og:url content=https://zoubingwu.com/2020-01-28/generator-in-javascript><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2020-01-28T17:13:31.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="Generator in JavaScript | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script></head><body><div class=content-container><div class=post><div class=post-title>Generator in JavaScript</div><span class=post-date><time>28 Jan 2020</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>javascript</span></a></li></ul></div><h2 id=what>what</h2><p>Generator 是一种特殊的函数，普通的函数只能返回一个值，而它被调用后会返回一个遍历器对象(iterator)，这个对象可以通过调用 next 方法来不断获得内部抛出的每一个值。</p><p>下面是一个一直返回递增整数的 generator：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">let</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">while</span><span style="color: #24292E"> (</span><span style="color: #005CC5">true</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #D73A49">++</span><span style="color: #24292E">i;</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">g</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">();</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">();  </span><span style="color: #6A737D">// -&gt; {value: 1, done: false}</span></span>
<span class=line><span style="color: #24292E">g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">();  </span><span style="color: #6A737D">// -&gt; {value: 2, done: false}</span></span>
<span class=line><span style="color: #24292E">g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">();  </span><span style="color: #6A737D">// -&gt; {value: 3, done: false}</span></span>
<span class=line><span style="color: #24292E">g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">();  </span><span style="color: #6A737D">// -&gt; {value: 4, done: false}</span></span>
<span class=line><span style="color: #24292E">g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">();  </span><span style="color: #6A737D">// -&gt; {value: 5, done: false}</span></span>
<span class=line><span style="color: #6A737D">// ...</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">while</span><span style="color: #C9D1D9"> (</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">i;</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">g</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">();</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();  </span><span style="color: #8B949E">// -&gt; {value: 1, done: false}</span></span>
<span class=line><span style="color: #C9D1D9">g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();  </span><span style="color: #8B949E">// -&gt; {value: 2, done: false}</span></span>
<span class=line><span style="color: #C9D1D9">g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();  </span><span style="color: #8B949E">// -&gt; {value: 3, done: false}</span></span>
<span class=line><span style="color: #C9D1D9">g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();  </span><span style="color: #8B949E">// -&gt; {value: 4, done: false}</span></span>
<span class=line><span style="color: #C9D1D9">g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();  </span><span style="color: #8B949E">// -&gt; {value: 5, done: false}</span></span>
<span class=line><span style="color: #8B949E">// ...</span></span></code></pre></div>
</code></pre><p>可以看到每次调用 <code>next</code> 方法，执行到 <code>yield</code> 时会将紧跟在 yield 后面的表达式的值，作为返回的对象的 <code>value</code> 属性值，然后就暂停了后续的执行，直到下一次调用 <code>next</code> 方法再重复这一过程。</p><p>只要是 <code>Iterator</code> 对象，都可以使用<code>for...of</code> 循环, <code>...</code> 扩展运算符，解构赋值和 <code>Array.from()</code> 方法。</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">numbers</span><span style="color: #24292E"> () {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #005CC5">2</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// 扩展运算符</span></span>
<span class=line><span style="color: #24292E">[</span><span style="color: #D73A49">...</span><span style="color: #6F42C1">numbers</span><span style="color: #24292E">()] </span><span style="color: #6A737D">// [1, 2]</span></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// Array.from 方法</span></span>
<span class=line><span style="color: #005CC5">Array</span><span style="color: #24292E">.</span><span style="color: #6F42C1">from</span><span style="color: #24292E">(</span><span style="color: #6F42C1">numbers</span><span style="color: #24292E">()) </span><span style="color: #6A737D">// [1, 2]</span></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// 解构赋值</span></span>
<span class=line><span style="color: #D73A49">let</span><span style="color: #24292E"> [x, y] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">numbers</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">x </span><span style="color: #6A737D">// 1</span></span>
<span class=line><span style="color: #24292E">y </span><span style="color: #6A737D">// 2</span></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// for...of 循环</span></span>
<span class=line><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">let</span><span style="color: #24292E"> n </span><span style="color: #D73A49">of</span><span style="color: #24292E"> </span><span style="color: #6F42C1">numbers</span><span style="color: #24292E">()) {</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(n)</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line><span style="color: #6A737D">// 1</span></span>
<span class=line><span style="color: #6A737D">// 2</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">numbers</span><span style="color: #C9D1D9"> () {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">2</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// 扩展运算符</span></span>
<span class=line><span style="color: #C9D1D9">[</span><span style="color: #FF7B72">...</span><span style="color: #D2A8FF">numbers</span><span style="color: #C9D1D9">()] </span><span style="color: #8B949E">// [1, 2]</span></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// Array.from 方法</span></span>
<span class=line><span style="color: #79C0FF">Array</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">from</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">numbers</span><span style="color: #C9D1D9">()) </span><span style="color: #8B949E">// [1, 2]</span></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// 解构赋值</span></span>
<span class=line><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> [x, y] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">numbers</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">x </span><span style="color: #8B949E">// 1</span></span>
<span class=line><span style="color: #C9D1D9">y </span><span style="color: #8B949E">// 2</span></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// for...of 循环</span></span>
<span class=line><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> n </span><span style="color: #FF7B72">of</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">numbers</span><span style="color: #C9D1D9">()) {</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(n)</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line><span style="color: #8B949E">// 1</span></span>
<span class=line><span style="color: #8B949E">// 2</span></span></code></pre></div>
</code></pre><p>由于 <code>yield</code> 表达式本身总是返回 <code>undefined</code> ，因此提供了一个方法来使得外部可以注入数据来修改上下文，那就是让 <code>next</code> 方法可以带一个参数：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #D73A49">*</span><span style="color: #6F42C1">gen</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">a</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;hello&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(a);</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">cont g </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">(); </span><span style="color: #6A737D">// { value: &#39;hello&#39;, done: false }</span></span>
<span class=line><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;hi&#39;</span><span style="color: #24292E">), </span><span style="color: #005CC5">1000</span><span style="color: #24292E">)  </span><span style="color: #6A737D">// 此时 a =&gt; &#39;hi&#39;   一秒后打印‘hi&#39;</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">*</span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">a</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;hello&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(a);</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">cont g </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">(); </span><span style="color: #8B949E">// { value: &#39;hello&#39;, done: false }</span></span>
<span class=line><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;hi&#39;</span><span style="color: #C9D1D9">), </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">)  </span><span style="color: #8B949E">// 此时 a =&gt; &#39;hi&#39;   一秒后打印‘hi&#39;</span></span></code></pre></div>
</code></pre><p>当然除了 <code>next()</code>，还提供了 <code>throw()</code> 和 <code>return()</code>，他们的本质其实是一样的，都是让 generator 恢复执行，并从外部注入不同的值来替换 yield 表达式。</p><p>Generator 内部也可以使用 <code>yield*</code> 语法来调用另外一个 generator：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">foo</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;a&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;b&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">bar</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;x&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">foo</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;y&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// 等同于</span></span>
<span class=line><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">bar</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;x&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;a&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;b&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;y&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">foo</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;a&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;b&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">bar</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;x&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">foo</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;y&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// 等同于</span></span>
<span class=line><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">bar</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;x&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;a&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;b&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;y&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><h2 id=use-case>use case</h2><p>可以看到 Generator 可以顺序的执行每一个任务，并且中途可以将执行权交给 <code>yield</code> 后的表达式，暂停后续操作，等到其完成后再拿回执行权继续后续操作。这使得在单线程的 JavaScript 环境中，可以很方便的控制复杂的异步流程。</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #6A737D">// callback style</span></span>
<span class=line><span style="color: #6F42C1">step1</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E"> (</span><span style="color: #E36209">value1</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">step2</span><span style="color: #24292E">(value1, </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">value2</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6F42C1">step3</span><span style="color: #24292E">(value2, </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">value3</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #6F42C1">step4</span><span style="color: #24292E">(value3, </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">value4</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #6A737D">// Do something with value4</span></span>
<span class=line><span style="color: #24292E">      });</span></span>
<span class=line><span style="color: #24292E">    });</span></span>
<span class=line><span style="color: #24292E">  });</span></span>
<span class=line><span style="color: #24292E">});</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// promise style</span></span>
<span class=line><span style="color: #005CC5">Promise</span><span style="color: #24292E">.</span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(step1)</span></span>
<span class=line><span style="color: #24292E">  .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(step2)</span></span>
<span class=line><span style="color: #24292E">  .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(step3)</span></span>
<span class=line><span style="color: #24292E">  .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(step4)</span></span>
<span class=line><span style="color: #24292E">  .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E"> (</span><span style="color: #E36209">value4</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6A737D">// Do something with value4</span></span>
<span class=line><span style="color: #24292E">  }, </span><span style="color: #D73A49">function</span><span style="color: #24292E"> (</span><span style="color: #E36209">error</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6A737D">// Handle any error from step1 through step4</span></span>
<span class=line><span style="color: #24292E">  })</span></span>
<span class=line><span style="color: #24292E">  .</span><span style="color: #6F42C1">done</span><span style="color: #24292E">();</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// generator style</span></span>
<span class=line><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">longRunningTask</span><span style="color: #24292E">(</span><span style="color: #E36209">value1</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">var</span><span style="color: #24292E"> value2 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">step1</span><span style="color: #24292E">(value1);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">var</span><span style="color: #24292E"> value3 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">step2</span><span style="color: #24292E">(value2);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">var</span><span style="color: #24292E"> value4 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">step3</span><span style="color: #24292E">(value3);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">var</span><span style="color: #24292E"> value5 </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">step4</span><span style="color: #24292E">(value4);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6A737D">// Do something with value4</span></span>
<span class=line><span style="color: #24292E">  } </span><span style="color: #D73A49">catch</span><span style="color: #24292E"> (e) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6A737D">// Handle any error from step1 through step4</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #8B949E">// callback style</span></span>
<span class=line><span style="color: #D2A8FF">step1</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">value1</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">step2</span><span style="color: #C9D1D9">(value1, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">value2</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">step3</span><span style="color: #C9D1D9">(value2, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">value3</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">step4</span><span style="color: #C9D1D9">(value3, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">value4</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// Do something with value4</span></span>
<span class=line><span style="color: #C9D1D9">      });</span></span>
<span class=line><span style="color: #C9D1D9">    });</span></span>
<span class=line><span style="color: #C9D1D9">  });</span></span>
<span class=line><span style="color: #C9D1D9">});</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// promise style</span></span>
<span class=line><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(step1)</span></span>
<span class=line><span style="color: #C9D1D9">  .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(step2)</span></span>
<span class=line><span style="color: #C9D1D9">  .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(step3)</span></span>
<span class=line><span style="color: #C9D1D9">  .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(step4)</span></span>
<span class=line><span style="color: #C9D1D9">  .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">value4</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Do something with value4</span></span>
<span class=line><span style="color: #C9D1D9">  }, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">error</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Handle any error from step1 through step4</span></span>
<span class=line><span style="color: #C9D1D9">  })</span></span>
<span class=line><span style="color: #C9D1D9">  .</span><span style="color: #D2A8FF">done</span><span style="color: #C9D1D9">();</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// generator style</span></span>
<span class=line><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">longRunningTask</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">value1</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> value2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">step1</span><span style="color: #C9D1D9">(value1);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> value3 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">step2</span><span style="color: #C9D1D9">(value2);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> value4 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">step3</span><span style="color: #C9D1D9">(value3);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> value5 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">step4</span><span style="color: #C9D1D9">(value4);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Do something with value4</span></span>
<span class=line><span style="color: #C9D1D9">  } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9"> (e) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Handle any error from step1 through step4</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>当然 generator 还需要我们一步一步手动调用 <code>next</code> 方法，但是我们可以写一个函数来调度这个流程，实际上已经有了现成的可以用，<a href=https://github.com/tj/co>co</a> 就是这样的一个流程调度器。</p><h2 id=how-co-works>how co works</h2><p>co 取自 <strong>coroutine</strong> ，中文一般翻译为协程，关于协程的更多内容可以查看<a href=https://dev.to/thibmaek/explain-coroutines-like-im-five-2d9>这篇文章</a></p><p>co 提供了一个函数，让你传入一个 generator 就可以自动执行：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">co</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">require</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;co&#39;</span><span style="color: #24292E">);</span></span>
<span class=line></span>
<span class=line><span style="color: #6F42C1">co</span><span style="color: #24292E">(</span><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6A737D">// resolve multiple promises in parallel</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">a</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">.</span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">b</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">.</span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(</span><span style="color: #005CC5">2</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">c</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">.</span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(</span><span style="color: #005CC5">3</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">res</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> [a, b, c];</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(res);</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6A737D">// =&gt; [1, 2, 3]</span></span>
<span class=line><span style="color: #24292E">});</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">co</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">require</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;co&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line></span>
<span class=line><span style="color: #D2A8FF">co</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// resolve multiple promises in parallel</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">a</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">b</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">2</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">c</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">3</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">res</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> [a, b, c];</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(res);</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// =&gt; [1, 2, 3]</span></span>
<span class=line><span style="color: #C9D1D9">});</span></span></code></pre></div>
</code></pre><p><code>yield</code> 后的表达式可以支持一系列的 yieldable 对象：</p><ul><li>promises</li><li>thunks (functions)</li><li>array (parallel execution)</li><li>objects (parallel execution)</li><li>generators (delegation)</li><li>generator functions (delegation)</li></ul><p>具体的介绍可以查看<a href=https://github.com/tj/co#yieldables>文档</a></p><p>co 是如何实现的呢？我们需要一个容器，来让每一次 <code>yield</code> 的操作有了结果以后，能够自动调用 <code>next</code> 来继续执行后续的操作。</p><p>我们可以自己尝试写一个非常简单的实现，希望它可以像下面这样执行，先等待一秒之后打印 1，然后再等待一秒之后打印错误：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #6F42C1">co</span><span style="color: #24292E">(</span><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">a</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncJob</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(a); </span><span style="color: #6A737D">// 等待 1000ms 后打印 1</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncErr</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  } </span><span style="color: #D73A49">catch</span><span style="color: #24292E"> (e) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(e); </span><span style="color: #6A737D">// 再等待 1000ms 后打印 error</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">});</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #D2A8FF">co</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">a</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncJob</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(a); </span><span style="color: #8B949E">// 等待 1000ms 后打印 1</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncErr</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9"> (e) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(e); </span><span style="color: #8B949E">// 再等待 1000ms 后打印 error</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">});</span></span></code></pre></div>
</code></pre><p>首先来模拟一下这两个异步操作：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncJob</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (</span><span style="color: #E36209">delay</span><span style="color: #24292E">, </span><span style="color: #E36209">callback</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">data</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">callback</span><span style="color: #24292E">(</span><span style="color: #005CC5">undefined</span><span style="color: #24292E">, data);</span></span>
<span class=line><span style="color: #24292E">}, delay);</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncErr</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (</span><span style="color: #E36209">delay</span><span style="color: #24292E">, </span><span style="color: #E36209">callback</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">err</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Error</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;oops&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">callback</span><span style="color: #24292E">(err);</span></span>
<span class=line><span style="color: #24292E">}, delay);</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncJob</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">delay</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">callback</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">data</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">callback</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">undefined</span><span style="color: #C9D1D9">, data);</span></span>
<span class=line><span style="color: #C9D1D9">}, delay);</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncErr</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">delay</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">callback</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">err</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Error</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;oops&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">callback</span><span style="color: #C9D1D9">(err);</span></span>
<span class=line><span style="color: #C9D1D9">}, delay);</span></span></code></pre></div>
</code></pre><p>上面是两个典型的类似 nodejs 回调风格的异步逻辑，我们显然没有办法直接通过 <code>yield asyncJob(delay, callback)</code> 这样的方式来调用，因为它直接就执行了，而实际上我们需要把它延迟到 <code>next</code> 方法里再去真正的调用 <code>setTimeout</code>。因此就需要对它进行一点改动：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncJob</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #E36209">delay</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #E36209">callback</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">data</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">callback</span><span style="color: #24292E">(</span><span style="color: #005CC5">undefined</span><span style="color: #24292E">, data);</span></span>
<span class=line><span style="color: #24292E">}, delay);</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncErr</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #E36209">delay</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #E36209">callback</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">err</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Error</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;oops&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">callback</span><span style="color: #24292E">(err);</span></span>
<span class=line><span style="color: #24292E">}, delay);</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncJob</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">delay</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">callback</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">data</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">callback</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">undefined</span><span style="color: #C9D1D9">, data);</span></span>
<span class=line><span style="color: #C9D1D9">}, delay);</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncErr</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">delay</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">callback</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">err</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Error</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;oops&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">callback</span><span style="color: #C9D1D9">(err);</span></span>
<span class=line><span style="color: #C9D1D9">}, delay);</span></span></code></pre></div>
</code></pre><p>可以看到这样的话，当我们执行到 <code>yield asyncJob(1000)</code> 时，generator 返回的 result 是一个如同 <code>{ value: callback =&gt; setTimeout(...), done: false }</code> 这样的 iterator 对象 ，此时我们再通过 <code>result.value()</code> 就可以真正执行异步逻辑了。</p><p>很容易就能实现一个这样的 co 函数：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">co</span><span style="color: #24292E">(</span><span style="color: #E36209">gen</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">g</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">();</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">next</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (</span><span style="color: #E36209">err</span><span style="color: #24292E">, </span><span style="color: #E36209">data</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (err) g.</span><span style="color: #6F42C1">throw</span><span style="color: #24292E">(err);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">result</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">(data);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (result.done) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">      result.</span><span style="color: #6F42C1">value</span><span style="color: #24292E">(next);</span></span>
<span class=line><span style="color: #24292E">    } </span><span style="color: #D73A49">catch</span><span style="color: #24292E"> (e) {</span></span>
<span class=line><span style="color: #24292E">      g.</span><span style="color: #6F42C1">throw</span><span style="color: #24292E">(e);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">next</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">co</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">gen</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">g</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">();</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">err</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">data</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (err) g.</span><span style="color: #D2A8FF">throw</span><span style="color: #C9D1D9">(err);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">result</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">(data);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (result.done) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">      result.</span><span style="color: #D2A8FF">value</span><span style="color: #C9D1D9">(next);</span></span>
<span class=line><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9"> (e) {</span></span>
<span class=line><span style="color: #C9D1D9">      g.</span><span style="color: #D2A8FF">throw</span><span style="color: #C9D1D9">(e);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>之前对异步操作的修改其实就涉及到了 thunk 的概念。</p><p><code>asyncJob</code> 和 <code>asyncErr</code> 在调用后返回了一个只接受 callback 作为参数的函数，在这里 <code>asyncJob</code> 和 <code>asyncErr</code> 就是 thunk，他们延迟了真正的异步逻辑（即 <code>setTimeout</code>）的调用，<code>setTimeout</code> 实际上是在我们定义的 <code>next</code> 函数里，通过<code>result.value(next)</code> 在被调用的。</p><p>但这个的 co 实现有个限制是 yield 后的表达式结果要接受一个类似 nodejs 的 error first 风格的回调函数作为参数。</p><p>co 的文档中有提到：</p><blockquote><p>Thunks are functions that only have a single argument, a callback.</p></blockquote><p>实际上 co 里的 thunk 是为了兼容 nodejs 中的 callback 风格 API 的，这样我们只需要把 callback 风格的 API 全部包装成 thunk 就可以直接通过 yield 来使用了。</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #6A737D">// nodejs</span></span>
<span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">readFile</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (</span><span style="color: #E36209">fileName</span><span style="color: #24292E">, </span><span style="color: #E36209">callback</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> fs.</span><span style="color: #6F42C1">readFile</span><span style="color: #24292E">(fileName, callback);</span></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// make it thunk</span></span>
<span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">readFileThunk</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #E36209">fileName</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #E36209">callback</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> fs.</span><span style="color: #6F42C1">readFile</span><span style="color: #24292E">(fileName, callback);</span></span>
<span class=line></span>
<span class=line><span style="color: #6F42C1">co</span><span style="color: #24292E">(</span><span style="color: #D73A49">function*</span><span style="color: #24292E"> () {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">data</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">readFileThunk</span><span style="color: #24292E">(fileName);</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(data);</span></span>
<span class=line><span style="color: #24292E">});</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #8B949E">// nodejs</span></span>
<span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readFile</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">fileName</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">callback</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> fs.</span><span style="color: #D2A8FF">readFile</span><span style="color: #C9D1D9">(fileName, callback);</span></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// make it thunk</span></span>
<span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readFileThunk</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">fileName</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">callback</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> fs.</span><span style="color: #D2A8FF">readFile</span><span style="color: #C9D1D9">(fileName, callback);</span></span>
<span class=line></span>
<span class=line><span style="color: #D2A8FF">co</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> () {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">data</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">readFileThunk</span><span style="color: #C9D1D9">(fileName);</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(data);</span></span>
<span class=line><span style="color: #C9D1D9">});</span></span></code></pre></div>
</code></pre><p>我们也可以写一个 thunkify 函数来负责所有的转换：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">thunkify</span><span style="color: #24292E">(</span><span style="color: #E36209">fn</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #D73A49">...</span><span style="color: #E36209">args</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #E36209">callback</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> fn.</span><span style="color: #6F42C1">call</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">, </span><span style="color: #D73A49">...</span><span style="color: #24292E">args, callback);</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">thunkify</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">fn</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">...</span><span style="color: #FFA657">args</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">callback</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> fn.</span><span style="color: #D2A8FF">call</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9">args, callback);</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>另外熟悉 redux 的同学肯定知道 redux-thunk，它的文档里是这么写的：</p><blockquote><p>A thunk is a function that wraps an expression to delay its evaluation.</p></blockquote><p>更多关于 thunk 概念的内容可以自行查阅资料。</p><p>但我们的 co 光支持 thunk 肯定不够，它的存在本身就是单纯为了兼容性，对于异步操作，现在更常见更主流的是使用 promise。</p><p>由于 thunk 函数也可以很简单就能转换成 promise，实际上我们可以把 generator 中 yield 出来的所有 value 全部都转换成 promise，然后统一处理：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">co</span><span style="color: #24292E">(</span><span style="color: #E36209">gen</span><span style="color: #24292E">){</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">g</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">();</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">((</span><span style="color: #E36209">resolve</span><span style="color: #24292E">, </span><span style="color: #E36209">reject</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">onFulfilled</span><span style="color: #24292E">(</span><span style="color: #E36209">res</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">let</span><span style="color: #24292E"> ret;</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">        ret </span><span style="color: #D73A49">=</span><span style="color: #24292E"> g.</span><span style="color: #6F42C1">next</span><span style="color: #24292E">(res);</span></span>
<span class=line><span style="color: #24292E">      } </span><span style="color: #D73A49">catch</span><span style="color: #24292E"> (e) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reject</span><span style="color: #24292E">(e);</span></span>
<span class=line><span style="color: #24292E">      }</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #6F42C1">next</span><span style="color: #24292E">(ret);</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">null</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">onRejected</span><span style="color: #24292E">(</span><span style="color: #E36209">err</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">let</span><span style="color: #24292E"> ret;</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">        ret </span><span style="color: #D73A49">=</span><span style="color: #24292E"> g.</span><span style="color: #6F42C1">throw</span><span style="color: #24292E">(err);</span></span>
<span class=line><span style="color: #24292E">      } </span><span style="color: #D73A49">catch</span><span style="color: #24292E"> (e) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reject</span><span style="color: #24292E">(e);</span></span>
<span class=line><span style="color: #24292E">      }</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #6F42C1">next</span><span style="color: #24292E">(ret);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">next</span><span style="color: #24292E">(</span><span style="color: #E36209">ret</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (ret.done) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(ret.value);</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">value</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">toPromise</span><span style="color: #24292E">(ret.value);</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> value.</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(onFulfilled, onRejected);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6F42C1">onFulfilled</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">  });</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #6F42C1">co</span><span style="color: #24292E">(gen);</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">co</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">gen</span><span style="color: #C9D1D9">){</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">g</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">();</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">resolve</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">reject</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">onFulfilled</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">res</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> ret;</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">        ret </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> g.</span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">(res);</span></span>
<span class=line><span style="color: #C9D1D9">      } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9"> (e) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">reject</span><span style="color: #C9D1D9">(e);</span></span>
<span class=line><span style="color: #C9D1D9">      }</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">(ret);</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">onRejected</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">err</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> ret;</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">        ret </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> g.</span><span style="color: #D2A8FF">throw</span><span style="color: #C9D1D9">(err);</span></span>
<span class=line><span style="color: #C9D1D9">      } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9"> (e) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">reject</span><span style="color: #C9D1D9">(e);</span></span>
<span class=line><span style="color: #C9D1D9">      }</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">(ret);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">next</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">ret</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (ret.done) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(ret.value);</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">value</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">toPromise</span><span style="color: #C9D1D9">(ret.value);</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> value.</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(onFulfilled, onRejected);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">onFulfilled</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">  });</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #D2A8FF">co</span><span style="color: #C9D1D9">(gen);</span></span></code></pre></div>
</code></pre><p>接下来就可以更方便的使用了：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncJobPromise</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #E36209">delay</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">(</span><span style="color: #E36209">resolve</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">), delay));</span></span>
<span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncErrPromise</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #E36209">delay</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">((</span><span style="color: #E36209">resolve</span><span style="color: #24292E">, </span><span style="color: #E36209">reject</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">reject</span><span style="color: #24292E">(</span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Error</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;oops&#39;</span><span style="color: #24292E">)), delay));</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">function*</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">a</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncJobPromise</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;a&#39;</span><span style="color: #24292E">, a);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">b</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncJob</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;b&#39;</span><span style="color: #24292E">, b);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncErrPromise</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  } </span><span style="color: #D73A49">catch</span><span style="color: #24292E"> (e) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(e);</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncErr</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  } </span><span style="color: #D73A49">catch</span><span style="color: #24292E"> (e) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(e);</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #6F42C1">co</span><span style="color: #24292E">(gen);</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncJobPromise</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">delay</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">resolve</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">), delay));</span></span>
<span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncErrPromise</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">delay</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">resolve</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">reject</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">reject</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Error</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;oops&#39;</span><span style="color: #C9D1D9">)), delay));</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">function*</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">a</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncJobPromise</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;a&#39;</span><span style="color: #C9D1D9">, a);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">b</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncJob</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;b&#39;</span><span style="color: #C9D1D9">, b);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncErrPromise</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9"> (e) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(e);</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncErr</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9"> (e) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(e);</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #D2A8FF">co</span><span style="color: #C9D1D9">(gen);</span></span></code></pre></div>
</code></pre><p>co 的核心实现其实就是这样，除了将 thunk 函数转换为 promise 以外，还可以不断完善，比如添加对数组的支持，这样可以通过 yield 一个 promise 组成的数组来完成并发的异步操作。</p><p>具体的实现可以去查看 co 的源码。</p><h2 id=asyncawait>async/await</h2><p>前面的 gen 函数，实际上已经和我们现在常用的 async/await 标准非常相似了, 我们只需要把函数声明加一个 async，然后 yield 替换成 await 就可以了，当然这一标准并不支持 await 一个 thunk：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">gen</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">a</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncJobPromise</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;a&#39;</span><span style="color: #24292E">, a);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncErrPromise</span><span style="color: #24292E">(</span><span style="color: #005CC5">1000</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  } </span><span style="color: #D73A49">catch</span><span style="color: #24292E"> (e) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(e);</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #6F42C1">gen</span><span style="color: #24292E">();</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">a</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncJobPromise</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;a&#39;</span><span style="color: #C9D1D9">, a);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncErrPromise</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9"> (e) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(e);</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #D2A8FF">gen</span><span style="color: #C9D1D9">();</span></span></code></pre></div>
</code></pre><p>这样的 async 函数执行时就会交给支持这一标准的 js 解释器自动执行了(例如 node &gt;= v7.6.0)。所以你可以简单的把 async/await 理解为 generator 的语法糖。</p><h2 id=saga>saga</h2><p>讲清楚了 Generator，我们就可以来看看 redux-saga 了。这里不赘述 redux-saga 的使用方法，具体可以查看文档。saga 通过 yield 各种各样的 effect 来处理复杂的异步或者副作用逻辑，而 effect 实际上就是一个描述异步逻辑的 Plain Object，就像 redux 中的 action 实际上就是一个描述如何修改状态 Plain Object。</p><p>redux-saga 提供了很多 Effect helper 来帮助你创建 effect，如 call、put、take 等等。比如 <code>yield call(fetchSomething)</code> 可能结果类似这样：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #24292E">{</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #E36209">isEffect</span><span style="color: #24292E">: </span><span style="color: #005CC5">true</span><span style="color: #24292E">,</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #E36209">type</span><span style="color: #24292E">: </span><span style="color: #032F62">&#39;CALL&#39;</span><span style="color: #24292E">,</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #E36209">fn</span><span style="color: #24292E">: fetchSomething</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #C9D1D9">{</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FFA657">isEffect</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">,</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FFA657">type</span><span style="color: #C9D1D9">: </span><span style="color: #A5D6FF">&#39;CALL&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FFA657">fn</span><span style="color: #C9D1D9">: fetchSomething</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>一样的，类似 redux action，effect 只是描述了意图，并不是真正的执行这个操作，真正的执行是在前文类似的 <code>next</code> 或者 <code>onFulfilled</code> 函数中调用的。但我们可以通过收集各种各样的 effect 来统一调度以实现更复杂的异步逻辑。</p><p>例如 <code>yield take(&#39;someActionType&#39;)</code>，saga 会在此处堵塞，只有在 <code>store.dispatch({type:&#39;someActionType&#39;})</code> 以后才会执行后续的逻辑，这么一看就非常像一个 event emitter 了，那么这个所谓的 「event」 是在哪里被订阅，又是怎么被消费的呢？</p><p>再比如，每次 yield 都会阻塞后续的执行直到这个 yield 后的表达式执行完成，但是用户可能还是希望能够使用非阻塞的异步逻辑，也就是 reudx-saga 的 fork model 要如何实现呢？</p><p>另外还有关于任务的取消等其他的复杂场景需要满足，我打算下篇文章再具体写写。</p><h2 id=reference>reference</h2><ul><li><a href=http://es6.ruanyifeng.com/#docs/generator>http://es6.ruanyifeng.com/#docs/generator</a></li><li><a href=https://dev.to/thibmaek/explain-coroutines-like-im-five-2d9>https://dev.to/thibmaek/explain-coroutines-like-im-five-2d9</a></li><li><a href=https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/ >https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/</a></li><li><a href=https://en.wikipedia.org/wiki/Thunk>https://en.wikipedia.org/wiki/Thunk</a></li><li><a href=https://daveceddia.com/what-is-a-thunk/ >https://daveceddia.com/what-is-a-thunk/</a></li><li><a href=https://github.com/tj/co>https://github.com/tj/co</a></li><li><a href=https://github.com/reduxjs/redux-thunk>https://github.com/reduxjs/redux-thunk</a></li><li><a href=https://github.com/redux-saga/redux-saga>https://github.com/redux-saga/redux-saga</a></li><li><a href=https://segmentfault.com/a/1190000016830003>https://segmentfault.com/a/1190000016830003</a></li></ul></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2021 zoubingwu. All rights reserved.</div></div></body></html>
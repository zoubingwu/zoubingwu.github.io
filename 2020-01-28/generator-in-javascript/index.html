<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=stylesheet href=/assets/fonts/font-awesome.min.css type=text/css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>Generator in JavaScript | https://zoubingwu.com</title><meta property=og:title content="Generator in JavaScript | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content="Let's talk about generator, coroutine, async/await and redux-saga..."><meta property=og:description content="Let's talk about generator, coroutine, async/await and redux-saga..."><link rel=canonical href=https://zoubingwu.com/2020-01-28/generator-in-javascript><meta property=og:url content=https://zoubingwu.com/2020-01-28/generator-in-javascript><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2020-01-28T17:13:31.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="Generator in JavaScript | https://zoubingwu.com"><script defer=defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "76b8468271b24f3180af2110f74841c3"}'></script></head><body><main class=content-container><div class=post><div class=post-title>Generator in JavaScript</div><span class=post-date><time>28 Jan 2020</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>javascript</span></a></li></ul></div><h2 id=what>what</h2><p>Generator 是一种特殊的函数，普通的函数只能返回一个值，而它被调用后会返回一个遍历器对象(iterator)，这个对象可以通过调用 next 方法来不断获得内部抛出的每一个值。</p><p>下面是一个一直返回递增整数的 generator：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">++</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">();</span></span>
<span class=line></span>
<span class=line><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">();  </span><span style="color: #7F848E; font-style: italic">// -&gt; {value: 1, done: false}</span></span>
<span class=line><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">();  </span><span style="color: #7F848E; font-style: italic">// -&gt; {value: 2, done: false}</span></span>
<span class=line><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">();  </span><span style="color: #7F848E; font-style: italic">// -&gt; {value: 3, done: false}</span></span>
<span class=line><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">();  </span><span style="color: #7F848E; font-style: italic">// -&gt; {value: 4, done: false}</span></span>
<span class=line><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">();  </span><span style="color: #7F848E; font-style: italic">// -&gt; {value: 5, done: false}</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// ...</span></span></code></pre>
</code></pre><p>可以看到每次调用 <code>next</code> 方法，执行到 <code>yield</code> 时会将紧跟在 yield 后面的表达式的值，作为返回的对象的 <code>value</code> 属性值，然后就暂停了后续的执行，直到下一次调用 <code>next</code> 方法再重复这一过程。</p><p>只要是 <code>Iterator</code> 对象，都可以使用<code>for...of</code> 循环, <code>...</code> 扩展运算符，解构赋值和 <code>Array.from()</code> 方法。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">numbers</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 扩展运算符</span></span>
<span class=line><span style="color: #ABB2BF">[...</span><span style="color: #61AFEF">numbers</span><span style="color: #ABB2BF">()] </span><span style="color: #7F848E; font-style: italic">// [1, 2]</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// Array.from 方法</span></span>
<span class=line><span style="color: #E5C07B">Array</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">from</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">numbers</span><span style="color: #ABB2BF">()) </span><span style="color: #7F848E; font-style: italic">// [1, 2]</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 解构赋值</span></span>
<span class=line><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> [</span><span style="color: #E06C75">x</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">y</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">numbers</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #E06C75">x</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">// 1</span></span>
<span class=line><span style="color: #E06C75">y</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">// 2</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// for...of 循环</span></span>
<span class=line><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">of</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">numbers</span><span style="color: #ABB2BF">()) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 1</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 2</span></span></code></pre>
</code></pre><p>由于 <code>yield</code> 表达式本身总是返回 <code>undefined</code> ，因此提供了一个方法来使得外部可以注入数据来修改上下文，那就是让 <code>next</code> 方法可以带一个参数：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">*</span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">a</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;hello&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">a</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #E06C75">cont</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">g</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">(); </span><span style="color: #7F848E; font-style: italic">// { value: &#39;hello&#39;, done: false }</span></span>
<span class=line><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;hi&#39;</span><span style="color: #ABB2BF">), </span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">)  </span><span style="color: #7F848E; font-style: italic">// 此时 a =&gt; &#39;hi&#39;   一秒后打印‘hi&#39;</span></span></code></pre>
</code></pre><p>当然除了 <code>next()</code>，还提供了 <code>throw()</code> 和 <code>return()</code>，他们的本质其实是一样的，都是让 generator 恢复执行，并从外部注入不同的值来替换 yield 表达式。</p><p>Generator 内部也可以使用 <code>yield*</code> 语法来调用另外一个 generator：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">foo</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;a&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;b&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">bar</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;x&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">foo</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;y&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 等同于</span></span>
<span class=line><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">bar</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;x&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;a&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;b&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;y&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><h2 id=use-case>use case</h2><p>可以看到 Generator 可以顺序的执行每一个任务，并且中途可以将执行权交给 <code>yield</code> 后的表达式，暂停后续操作，等到其完成后再拿回执行权继续后续操作。这使得在单线程的 JavaScript 环境中，可以很方便的控制复杂的异步流程。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// callback style</span></span>
<span class=line><span style="color: #61AFEF">step1</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">value1</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">step2</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">value1</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">value2</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">step3</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">value2</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">value3</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #61AFEF">step4</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">value3</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">value4</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic">// Do something with value4</span></span>
<span class=line><span style="color: #ABB2BF">      });</span></span>
<span class=line><span style="color: #ABB2BF">    });</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// promise style</span></span>
<span class=line><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">step1</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">step2</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">step3</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">step4</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">value4</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// Do something with value4</span></span>
<span class=line><span style="color: #ABB2BF">  }, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">error</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// Handle any error from step1 through step4</span></span>
<span class=line><span style="color: #ABB2BF">  })</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">done</span><span style="color: #ABB2BF">();</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// generator style</span></span>
<span class=line><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">longRunningTask</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">value1</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">value2</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">step1</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">value1</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">value3</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">step2</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">value2</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">value4</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">step3</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">value3</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">value5</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">step4</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">value4</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// Do something with value4</span></span>
<span class=line><span style="color: #ABB2BF">  } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// Handle any error from step1 through step4</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>当然 generator 还需要我们一步一步手动调用 <code>next</code> 方法，但是我们可以写一个函数来调度这个流程，实际上已经有了现成的可以用，<a href=https://github.com/tj/co>co</a> 就是这样的一个流程调度器。</p><h2 id=how-co-works>how co works</h2><p>co 取自 <strong>coroutine</strong> ，中文一般翻译为协程，关于协程的更多内容可以查看<a href=https://dev.to/thibmaek/explain-coroutines-like-im-five-2d9>这篇文章</a></p><p>co 提供了一个函数，让你传入一个 generator 就可以自动执行：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">co</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">require</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;co&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">co</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">(){</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// resolve multiple promises in parallel</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">a</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">b</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">c</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">res</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> [</span><span style="color: #E06C75">a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">c</span><span style="color: #ABB2BF">];</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">res</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// =&gt; [1, 2, 3]</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p><code>yield</code> 后的表达式可以支持一系列的 yieldable 对象：</p><ul><li>promises</li><li>thunks (functions)</li><li>array (parallel execution)</li><li>objects (parallel execution)</li><li>generators (delegation)</li><li>generator functions (delegation)</li></ul><p>具体的介绍可以查看<a href=https://github.com/tj/co#yieldables>文档</a></p><p>co 是如何实现的呢？我们需要一个容器，来让每一次 <code>yield</code> 的操作有了结果以后，能够自动调用 <code>next</code> 来继续执行后续的操作。</p><p>我们可以自己尝试写一个非常简单的实现，希望它可以像下面这样执行，先等待一秒之后打印 1，然后再等待一秒之后打印错误：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">co</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">a</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncJob</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">a</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic">// 等待 1000ms 后打印 1</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncErr</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic">// 再等待 1000ms 后打印 error</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>首先来模拟一下这两个异步操作：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncJob</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">delay</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">callback</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">callback</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">undefined</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}, </span><span style="color: #E06C75">delay</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncErr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">delay</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">callback</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">err</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;oops&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">callback</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}, </span><span style="color: #E06C75">delay</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>上面是两个典型的类似 nodejs 回调风格的异步逻辑，我们显然没有办法直接通过 <code>yield asyncJob(delay, callback)</code> 这样的方式来调用，因为它直接就执行了，而实际上我们需要把它延迟到 <code>next</code> 方法里再去真正的调用 <code>setTimeout</code>。因此就需要对它进行一点改动：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncJob</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">delay</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">callback</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">callback</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">undefined</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}, </span><span style="color: #E06C75">delay</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncErr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">delay</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">callback</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">err</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;oops&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">callback</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}, </span><span style="color: #E06C75">delay</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>可以看到这样的话，当我们执行到 <code>yield asyncJob(1000)</code> 时，generator 返回的 result 是一个如同 <code>{ value: callback =&gt; setTimeout(...), done: false }</code> 这样的 iterator 对象 ，此时我们再通过 <code>result.value()</code> 就可以真正执行异步逻辑了。</p><p>很容易就能实现一个这样的 co 函数：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">co</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">gen</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">();</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">) </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">throw</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">done</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">value</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">next</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">throw</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>之前对异步操作的修改其实就涉及到了 thunk 的概念。</p><p><code>asyncJob</code> 和 <code>asyncErr</code> 在调用后返回了一个只接受 callback 作为参数的函数，在这里 <code>asyncJob</code> 和 <code>asyncErr</code> 就是 thunk，他们延迟了真正的异步逻辑（即 <code>setTimeout</code>）的调用，<code>setTimeout</code> 实际上是在我们定义的 <code>next</code> 函数里，通过<code>result.value(next)</code> 在被调用的。</p><p>但这个的 co 实现有个限制是 yield 后的表达式结果要接受一个类似 nodejs 的 error first 风格的回调函数作为参数。</p><p>co 的文档中有提到：</p><blockquote><p>Thunks are functions that only have a single argument, a callback.</p></blockquote><p>实际上 co 里的 thunk 是为了兼容 nodejs 中的 callback 风格 API 的，这样我们只需要把 callback 风格的 API 全部包装成 thunk 就可以直接通过 yield 来使用了。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// nodejs</span></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">readFile</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">fileName</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">callback</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">readFile</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">fileName</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">callback</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// make it thunk</span></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">readFileThunk</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">fileName</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">callback</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">readFile</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">fileName</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">callback</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">co</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">readFileThunk</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">fileName</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>我们也可以写一个 thunkify 函数来负责所有的转换：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">thunkify</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">fn</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(...</span><span style="color: #E06C75; font-style: italic">args</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">callback</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">fn</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">call</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">, ...</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">callback</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>另外熟悉 redux 的同学肯定知道 redux-thunk，它的文档里是这么写的：</p><blockquote><p>A thunk is a function that wraps an expression to delay its evaluation.</p></blockquote><p>更多关于 thunk 概念的内容可以自行查阅资料。</p><p>但我们的 co 光支持 thunk 肯定不够，它的存在本身就是单纯为了兼容性，对于异步操作，现在更常见更主流的是使用 promise。</p><p>由于 thunk 函数也可以很简单就能转换成 promise，实际上我们可以把 generator 中 yield 出来的所有 value 全部都转换成 promise，然后统一处理：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">co</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">gen</span><span style="color: #ABB2BF">){</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">();</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">((</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">reject</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">onFulfilled</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">res</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ret</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E06C75">ret</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">res</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">reject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      }</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">ret</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">onRejected</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ret</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E06C75">ret</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">g</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">throw</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">reject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      }</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">ret</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">next</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">ret</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">ret</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">done</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">ret</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">value</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">value</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">toPromise</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">ret</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">value</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">value</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">onFulfilled</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">onRejected</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">onFulfilled</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">co</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">gen</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>接下来就可以更方便的使用了：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncJobPromise</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">delay</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">), </span><span style="color: #E06C75">delay</span><span style="color: #ABB2BF">));</span></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncErrPromise</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">delay</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">((</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">reject</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">reject</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;oops&#39;</span><span style="color: #ABB2BF">)), </span><span style="color: #E06C75">delay</span><span style="color: #ABB2BF">));</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">function*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">a</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncJobPromise</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;a&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">a</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">b</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncJob</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;b&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">b</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncErrPromise</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncErr</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">co</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">gen</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>co 的核心实现其实就是这样，除了将 thunk 函数转换为 promise 以外，还可以不断完善，比如添加对数组的支持，这样可以通过 yield 一个 promise 组成的数组来完成并发的异步操作。</p><p>具体的实现可以去查看 co 的源码。</p><h2 id=asyncawait>async/await</h2><p>前面的 gen 函数，实际上已经和我们现在常用的 async/await 标准非常相似了, 我们只需要把函数声明加一个 async，然后 yield 替换成 await 就可以了，当然这一标准并不支持 await 一个 thunk：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">async</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">a</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncJobPromise</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;a&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">a</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncErrPromise</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">gen</span><span style="color: #ABB2BF">();</span></span></code></pre>
</code></pre><p>这样的 async 函数执行时就会交给支持这一标准的 js 解释器自动执行了(例如 node &gt;= v7.6.0)。所以你可以简单的把 async/await 理解为 generator 的语法糖。</p><h2 id=saga>saga</h2><p>讲清楚了 Generator，我们就可以来看看 redux-saga 了。这里不赘述 redux-saga 的使用方法，具体可以查看文档。saga 通过 yield 各种各样的 effect 来处理复杂的异步或者副作用逻辑，而 effect 实际上就是一个描述异步逻辑的 Plain Object，就像 redux 中的 action 实际上就是一个描述如何修改状态 Plain Object。</p><p>redux-saga 提供了很多 Effect helper 来帮助你创建 effect，如 call、put、take 等等。比如 <code>yield call(fetchSomething)</code> 可能结果类似这样：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">{</span></span>
<span class=line><span style="color: #ABB2BF">  isEffect: </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  type: </span><span style="color: #98C379">&#39;CALL&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  fn: </span><span style="color: #E06C75">fetchSomething</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>一样的，类似 redux action，effect 只是描述了意图，并不是真正的执行这个操作，真正的执行是在前文类似的 <code>next</code> 或者 <code>onFulfilled</code> 函数中调用的。但我们可以通过收集各种各样的 effect 来统一调度以实现更复杂的异步逻辑。</p><p>例如 <code>yield take(&#39;someActionType&#39;)</code>，saga 会在此处堵塞，只有在 <code>store.dispatch({type:&#39;someActionType&#39;})</code> 以后才会执行后续的逻辑，这么一看就非常像一个 event emitter 了，那么这个所谓的 「event」 是在哪里被订阅，又是怎么被消费的呢？</p><p>再比如，每次 yield 都会阻塞后续的执行直到这个 yield 后的表达式执行完成，但是用户可能还是希望能够使用非阻塞的异步逻辑，也就是 reudx-saga 的 fork model 要如何实现呢？</p><p>另外还有关于任务的取消等其他的复杂场景需要满足，我打算下篇文章再具体写写。</p><h2 id=reference>reference</h2><ul><li><a href=http://es6.ruanyifeng.com/#docs/generator>http://es6.ruanyifeng.com/#docs/generator</a></li><li><a href=https://dev.to/thibmaek/explain-coroutines-like-im-five-2d9>https://dev.to/thibmaek/explain-coroutines-like-im-five-2d9</a></li><li><a href=https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/ >https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/</a></li><li><a href=https://en.wikipedia.org/wiki/Thunk>https://en.wikipedia.org/wiki/Thunk</a></li><li><a href=https://daveceddia.com/what-is-a-thunk/ >https://daveceddia.com/what-is-a-thunk/</a></li><li><a href=https://github.com/tj/co>https://github.com/tj/co</a></li><li><a href=https://github.com/reduxjs/redux-thunk>https://github.com/reduxjs/redux-thunk</a></li><li><a href=https://github.com/redux-saga/redux-saga>https://github.com/redux-saga/redux-saga</a></li><li><a href=https://segmentfault.com/a/1190000016830003>https://segmentfault.com/a/1190000016830003</a></li></ul></div><div class=footer><hr><div class=footer-link><a href=/archive aria-label="Read more about all archives"><i class="fa fa-archive" aria-hidden=true></i> </a><a target=_blank href=https://twitter.com/chow_won aria-label="Read more on twitter"><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu aria-label="Read more on github"><i class="fa fa-github" aria-hidden=true></i> </a><a target=_blank href=mailto:zoubingwu@gmail.com aria-label=Email><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2023 zoubingwu. All rights reserved.</div></main></body></html>
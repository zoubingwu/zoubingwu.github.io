<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=preload href=/assets/fonts/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>Memoization in Javascript | https://zoubingwu.com</title><meta property=og:title content="Memoization in Javascript | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content="Memoization is an optimization technique used primarily to speed up computer programs by storing the results of expensive function calls and returning the cached result when the same inputs occur again. "><meta property=og:description content="Memoization is an optimization technique used primarily to speed up computer programs by storing the results of expensive function calls and returning the cached result when the same inputs occur again. "><link rel=canonical href=https://zoubingwu.com/2018-02-14/memoization-in-javascript><meta property=og:url content=https://zoubingwu.com/2018-02-14/memoization-in-javascript><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2018-02-14T12:33:21.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="Memoization in Javascript | https://zoubingwu.com"><script defer=defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "76b8468271b24f3180af2110f74841c3"}'></script></head><body><main class=content-container><div class=post><div class=post-title>Memoization in Javascript</div><span class=post-date><time>14 Feb 2018</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>javascript</span></a></li></ul></div><h3 id=introduction>Introduction</h3><p>函数是编程语言中不可或缺的重要部分，有了函数，我们才能复用各种代码。我们的程序通常都会由各种各样的函数组成，在需要的时候调用这些函数来实现各种功能。</p><p>但是某些函数的调用多次的代价可能是非常高昂的，比如说最简单的一个计算阶乘的递归函数。</p><p>比如：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">times</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">n</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">||</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">`calculating </span><span style="color: #C678DD">${</span><span style="color: #56B6C2">++</span><span style="color: #E06C75">times</span><span style="color: #C678DD">}</span><span style="color: #98C379"> times`</span><span style="color: #ABB2BF">)</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">)</span></span></code></pre>
</code></pre><p>我们可以看到每一次我们调用，传入一个同样的参数，计算机都会重复的从头到尾计算一遍，哪怕之前已经计算过，知道了结果是什么。因此为了优化，自然有人就想到了，如果我们可以把每次计算的结果缓存到内存里，如果参数没有改变，那就直接返回这个缓存的结果就好了。这是一种以空间换时间的优化方式。</p><p>我们可以先看一个更简单的例子：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">double</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">n</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">memoize</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">fn</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">cache</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {}; </span><span style="color: #7F848E; font-style: italic">// create a cache object</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">n</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">cache</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;we found it in cache!&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">cache</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">];</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;calculating ...&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">fn</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">cache</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">; </span><span style="color: #7F848E; font-style: italic">// store it in cache</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">memoizedDouble</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">memoize</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">double</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">memoizedDouble</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">) </span><span style="color: #7F848E; font-style: italic">// calculating ...</span></span>
<span class=line><span style="color: #61AFEF">memoizedDouble</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">) </span><span style="color: #7F848E; font-style: italic">// we found it in cache!</span></span>
<span class=line><span style="color: #61AFEF">memoizedDouble</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">) </span><span style="color: #7F848E; font-style: italic">// calculating ...</span></span>
<span class=line><span style="color: #61AFEF">memoizedDouble</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">) </span><span style="color: #7F848E; font-style: italic">// we found it in cache!</span></span>
<span class=line><span style="color: #61AFEF">memoizedDouble</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">) </span><span style="color: #7F848E; font-style: italic">// we found it in cache!</span></span></code></pre>
</code></pre><p>这也是所谓 javascript 闭包的典型运用，上面的 memoize 函数实际上是实现了一个 size 无限大的缓存，只要不同的参数，运算过一次以后，都会存入缓存中。</p><p>但是我们传入一个递归函数进去是无法实现目的的，这个时候应该确保递归时，也应调用这个记忆后的函数。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// same memoize function</span></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">memoize</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">fn</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">cache</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {}; </span><span style="color: #7F848E; font-style: italic">// create a cache object</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">n</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">cache</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;we found it in cache!&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">cache</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">];</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;calculating ...&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">fn</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">cache</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">; </span><span style="color: #7F848E; font-style: italic">// store it in cache</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">factorial</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">memoize</span><span style="color: #ABB2BF">(</span></span>
<span class=line><span style="color: #ABB2BF">  (</span><span style="color: #E06C75; font-style: italic">n</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">)</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">) </span><span style="color: #7F848E; font-style: italic">// calculating ... </span></span>
<span class=line><span style="color: #61AFEF">factorial</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">) </span><span style="color: #7F848E; font-style: italic">// we found it in cache!</span></span></code></pre>
</code></pre><p>可以发现实际上缓存中实际上保存从 1 到 10 所有的阶乘结果。</p><p>缓存这种存储某些数据以给将来的使用这一概念，其实上运用到的地方非常多，比如 http 缓存，而 Memoization 基本上就是这种特定的，缓存函数返回值的技术。</p><h3 id=when-to-memoize>when to memoize</h3><p>通常我们并不会在所有的地方都使用这种空间换时间的优化技术，一般来说有下面几个规律：</p><ul><li><p>函数首先必须是一个 pure function，每次对于相同的输入，都应该有相同的返回。</p></li><li><p>因为是为了以空间交换时间，因此函数必须有着有限的输入范围，来让缓存的值可以呗被频繁的多次使用。</p></li><li><p>最合适的使用时机，应该是针对需要大量计算的 heavy computational function, 可以极大的提高性能。</p></li></ul><p>如果对 React 相关生态的比较熟悉的话，就知道有一个 Reselect 的工具库，来帮助优化从 state 树提取数据映射到相关组件这一过程。它的源码也非常短小精悍，值得一读。</p></div><div class=footer><hr><div class=footer-link><a href=/archive aria-label="Read more about all archives"><i class="fa fa-archive" aria-hidden=true></i> </a><a target=_blank href=https://twitter.com/chow_won aria-label="Read more on twitter"><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu aria-label="Read more on github"><i class="fa fa-github" aria-hidden=true></i> </a><a target=_blank href=mailto:zoubingwu@gmail.com aria-label=Email><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2023 zoubingwu. All rights reserved.</div></main></body></html>
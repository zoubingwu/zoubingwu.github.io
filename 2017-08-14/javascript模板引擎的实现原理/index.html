<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=stylesheet href=/assets/fonts/fontawesome.min.css type=text/css><link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300;1,700&display=swap" rel=stylesheet><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>JavaScript模板引擎的实现原理 | https://zoubingwu.com</title><meta property=og:title content="JavaScript模板引擎的实现原理 | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content=只用几十行代码来实现一个简单的JavaScript模板引擎><meta property=og:description content=只用几十行代码来实现一个简单的JavaScript模板引擎><link rel=canonical href=https://zoubingwu.com/2017-08-14/javascript模板引擎的实现原理><meta property=og:url content=https://zoubingwu.com/2017-08-14/javascript模板引擎的实现原理><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2017-08-14T14:59:41.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="JavaScript模板引擎的实现原理 | https://zoubingwu.com"><script defer=defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "76b8468271b24f3180af2110f74841c3"}'></script></head><body><main class=content-container><div class=post><div class=post-title>JavaScript模板引擎的实现原理</div><span class=post-date><time>14 Aug 2017</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>template</span></a></li><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>compiler</span></a></li></ul></div><h3 id=前言>前言</h3><p>继续我们对于编译的学习，这一次我们来尝试实现一个简单的JS模板引擎，模板引擎在许多地方都有应用到，比如vue中的数据的动态替换，webpack的html-webpack-plungin插件，node中的jade模板引擎等，使得我们可以直接在html文件中使用JavaScript的语法来动态生成我们需要的html，或是动态替换html中的变量。</p><p>我们来把问题具象化为下面的例子：</p><pre><code class=language-html><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">&lt;!-- template --&gt;</span></span>
<span class=line><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">p</span><span style="color: #ABB2BF">&gt;Hello, my name is </span><span style="color: #FFFFFF">&lt;</span><span style="color: #ABB2BF">%name%&gt;. I\&#39;m </span><span style="color: #FFFFFF">&lt;</span><span style="color: #ABB2BF">%age%&gt; years old.&lt;/</span><span style="color: #E06C75">p</span><span style="color: #ABB2BF">&gt;</span></span></code></pre>
</code></pre><p>我们需要实现一个js函数，来将其中的name和age变量替换为我们所提供的值，出于简化的原因，这里我们直接把这一串html代码当成js中的字符串来处理，而不使用node中的readFile了。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">tplEngine</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">tpl</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// ...code here</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">tpl</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&lt;p&gt;Hello, my name is &lt;%name%&gt;. I</span><span style="color: #56B6C2">\&#39;</span><span style="color: #98C379">m &lt;%age%&gt; years old.&lt;/p&gt;&#39;</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">tplEngine</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">tpl</span><span style="color: #ABB2BF">, {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&quot;jack&quot;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">age</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">29</span></span>
<span class=line><span style="color: #ABB2BF">})</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// should return &lt;p&gt;Hello, my name is jack. I&#39;m 29 years old.&lt;/p&gt;</span></span></code></pre>
</code></pre><h3 id=正则表达式提取>正则表达式提取</h3><p>使用正则表达式是最简单粗暴的做法，直接找到字符串中的变量部分然后来替换。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reg</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #56B6C2"> </span><span style="color: #98C379">/</span><span style="color: #56B6C2">&lt;%(</span><span style="color: #D19A66">[</span><span style="color: #ABB2BF">^</span><span style="color: #D19A66">%&gt;]+</span><span style="color: #56B6C2">)</span><span style="color: #D19A66">?</span><span style="color: #56B6C2">%&gt;</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">tpl</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&lt;p&gt;Hello, my name is &lt;%name%&gt;. I</span><span style="color: #56B6C2">\&#39;</span><span style="color: #98C379">m &lt;%age%&gt; years old.&lt;/p&gt;&#39;</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">match</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">match</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">reg</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">exec</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">tpl</span><span style="color: #ABB2BF">)) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">match</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>可以看到上述代码的结果是：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">[ </span><span style="color: #98C379">&#39;&lt;%name%&gt;&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #98C379">&#39;name&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">index</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">21</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">input</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;&lt;p&gt;Hello, my name is &lt;%name%&gt;. I</span><span style="color: #56B6C2">\&#39;</span><span style="color: #98C379">m &lt;%age%&gt; years old.&lt;/p&gt;&#39;</span><span style="color: #ABB2BF"> ]</span></span>
<span class=line><span style="color: #ABB2BF">[ </span><span style="color: #98C379">&#39;&lt;%age%&gt;&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #98C379">&#39;age&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">index</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">35</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">input</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;&lt;p&gt;Hello, my name is &lt;%name%&gt;. I</span><span style="color: #56B6C2">\&#39;</span><span style="color: #98C379">m &lt;%age%&gt; years old.&lt;/p&gt;&#39;</span><span style="color: #ABB2BF"> ]</span></span></code></pre>
</code></pre><h3 id=流程控制语法>流程控制语法</h3><p>在替换的时候我们如果将其看作字符串，使用字符串的replace等方法在这个简单的例子里是可以达成目的的，但是实际使用中就没有这么简单了，我们可能会碰到多层次的对象结构，甚至是js的循环、判断等流程控制的语法。因此有必要将其当作js代码来执行。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&lt;p&gt;Hello, my name is &#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;, and I</span><span style="color: #56B6C2">\&#39;</span><span style="color: #98C379">m &#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">info</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">age</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39; years old.&lt;/p&gt;&#39;</span></span></code></pre>
</code></pre><p>但对于循环的话:</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">template</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span></span>
<span class=line><span style="color: #98C379">&#39;My skills:&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span></span>
<span class=line><span style="color: #98C379">&#39;&lt;% for(var index in this.skills) { %&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;a href=&quot;&quot;&gt;&lt;%this.skills[index]%&gt;&lt;/a&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;% } %&gt;&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 如果继续采用上面的方式，得到的结果会报错：</span></span>
<span class=line><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;My skills:&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #C678DD">for</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">index</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">) { </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;a href=&quot;&quot;&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">index</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;/a&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 而我们需要的应该是这样的：</span></span>
<span class=line><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;My skills:&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span></span>
<span class=line><span style="color: #98C379">&#39;&lt;a href=&quot;&quot;&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span></span>
<span class=line><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;/a&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;a href=&quot;&quot;&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span></span>
<span class=line><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;/a&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;a href=&quot;&quot;&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span></span>
<span class=line><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;/a&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span></code></pre>
</code></pre><p>这就比较容易看出来了，我们可以使用一个数组来控制其内容，使得只把需要的内容push进数组，而流程控制的代码则在外部负责，这样代码应该是这个样子:</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">r</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [];</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;My skills:&#39;</span><span style="color: #ABB2BF">); </span></span>
<span class=line><span style="color: #C678DD">for</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">index</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;&lt;a href=&quot;&quot;&gt;&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">index</span><span style="color: #ABB2BF">]);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;&lt;/a&gt;&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;&#39;</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>但是在这之前，我们的字符串首先要转换转换成上面的js代码才能获得最后的结果，这个转换的过程要如何完成呢，我们需要利用 <code>new Fucuntion()</code> 构造函数来实现，它接受两个参数，第一个作为结果函数的参数，第二个则作为函数语句，举一个简单的例子：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">fn</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Function</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;args&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;console.log(args)&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #61AFEF">fn</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;hello world&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 其结果等同于：</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">fn</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">args</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>那么现在我们需要通过构造一个字符串来把之前的一串流程控制和内容添加进数组的语句来作为我们的第二个参数：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;jack&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">age</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">29</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">: [</span><span style="color: #98C379">&quot;js&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;html&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;css&quot;</span><span style="color: #ABB2BF">]</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reg</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #56B6C2"> </span><span style="color: #98C379">/</span><span style="color: #56B6C2">&lt;%(</span><span style="color: #D19A66">[</span><span style="color: #ABB2BF">^</span><span style="color: #D19A66">%&gt;]+</span><span style="color: #56B6C2">)</span><span style="color: #D19A66">?</span><span style="color: #56B6C2">%&gt;</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">tpl</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&lt;p&gt;Hello, my name is &lt;% data.name %&gt;. I</span><span style="color: #56B6C2">\&#39;</span><span style="color: #98C379">m &lt;% data.age %&gt; years old.&lt;/p&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span></span>
<span class=line><span style="color: #98C379">&#39;&lt;p&gt;My skills are &lt;% for (var index in data.skills) { %&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;a href=&quot;#&quot;&gt;&lt;% data.skills[index] %&gt;&lt;/a&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #98C379">&#39;&lt;% } %&gt;&lt;/p&gt;&#39;</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">match</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;var r = [];</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">cursor</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">line</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;r.push(&quot;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">replace</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">/</span><span style="color: #56B6C2">&quot;</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">&quot;&#39;</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&quot;);</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">match</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">reg</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">exec</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">tpl</span><span style="color: #ABB2BF">)) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">tpl</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">slice</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">cursor</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">match</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">index</span><span style="color: #ABB2BF">));</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">match</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">]);</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">cursor</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">match</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">index</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">match</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">].</span><span style="color: #E06C75">length</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 运行后code的结果为(字符串)，作为第二个参数传入后相当于以下代码：</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">r</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [];</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;&lt;p&gt;Hello, my name is &quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;data.name&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;. I&#39;m &quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;data.age&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot; years old.&lt;/p&gt;&lt;p&gt;My skills are &quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;for (var index in data.skills) {&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;&lt;a href=</span><span style="color: #56B6C2">\&quot;</span><span style="color: #98C379">#</span><span style="color: #56B6C2">\&quot;</span><span style="color: #98C379">&gt;&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;data.skills[index]&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;&lt;/a&gt;&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;}&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>可以看到，我们实际上需要的js代码也被当成字符串用双引号包起来了，因此需要在add函数上多做一个判断：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">line</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">js</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">js</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">?</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;r.push(&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;);</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span></span>
<span class=line><span style="color: #ABB2BF">     </span><span style="color: #C678DD">:</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;r.push(&quot;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">replace</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">/</span><span style="color: #56B6C2">&quot;</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">&quot;&#39;</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&quot;);</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>另外，流程控制的for循环语句也被push进了数组，但是实际上我们需要的是直接当成js执行，把循环语句内部的代码反复push进数组，因此add函数内部继续改进：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">reExp</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/</span><span style="color: #56B6C2">(</span><span style="color: #C678DD">^</span><span style="color: #56B6C2">( )</span><span style="color: #D19A66">?</span><span style="color: #56B6C2">(if</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">for</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">else</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">switch</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">case</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">break</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">{</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">}))(</span><span style="color: #E06C75">.</span><span style="color: #D19A66">*</span><span style="color: #56B6C2">)</span><span style="color: #D19A66">?</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">line</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">js</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">js</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">?</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">match</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">reExp</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">?</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">:</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;r.push(&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;);</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span></span>
<span class=line><span style="color: #ABB2BF">     </span><span style="color: #C678DD">:</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;r.push(&quot;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">replace</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">/</span><span style="color: #56B6C2">&quot;</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">&quot;&#39;</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&quot;);</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>那么终于最后的code结果就是我们想要的了：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">r</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [];</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;&lt;p&gt;Hello, my name is &quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;. I&#39;m &quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">age</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot; years old.&lt;/p&gt;&lt;p&gt;My skills are &quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">index</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;&lt;a href=</span><span style="color: #56B6C2">\&quot;</span><span style="color: #98C379">#</span><span style="color: #56B6C2">\&quot;</span><span style="color: #98C379">&gt;&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">index</span><span style="color: #ABB2BF">]);</span></span>
<span class=line><span style="color: #E5C07B">r</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">push</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;&lt;/a&gt;&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>这样我们就可以将其传入function构造函数来把字符串直接作为js代码执行，最后的代码就类似下面这样:</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">TemplateEngine</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">html</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">options</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">re</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #56B6C2"> </span><span style="color: #98C379">/</span><span style="color: #56B6C2">&lt;%(</span><span style="color: #D19A66">[</span><span style="color: #ABB2BF">^</span><span style="color: #D19A66">%&gt;]+</span><span style="color: #56B6C2">)</span><span style="color: #D19A66">?</span><span style="color: #56B6C2">%&gt;</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">reExp</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/</span><span style="color: #56B6C2">(</span><span style="color: #C678DD">^</span><span style="color: #56B6C2">( )</span><span style="color: #D19A66">?</span><span style="color: #56B6C2">(if</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">for</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">else</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">switch</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">case</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">break</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">{</span><span style="color: #ABB2BF">|</span><span style="color: #56B6C2">}))(</span><span style="color: #E06C75">.</span><span style="color: #D19A66">*</span><span style="color: #56B6C2">)</span><span style="color: #D19A66">?</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;var r=[];</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">cursor</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">match</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">line</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">isJs</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">isJs</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">?</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">match</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">reExp</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">?</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">:</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;r.push(&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;);</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">         </span><span style="color: #C678DD">:</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">line</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">?</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;r.push(&quot;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">line</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">replace</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">/</span><span style="color: #56B6C2">&quot;</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">&quot;&#39;</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&quot;);</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">:</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">match</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">re</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">exec</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">html</span><span style="color: #ABB2BF">)) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">html</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">slice</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">cursor</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">match</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">index</span><span style="color: #ABB2BF">));</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">match</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">], </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">cursor</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">match</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">index</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">match</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">].</span><span style="color: #E06C75">length</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">add</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">html</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">substr</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">cursor</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">html</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">length</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">cursor</span><span style="color: #ABB2BF">));</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">code</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;return r.join(&quot;&quot;);&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Function</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">code</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">replace</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">/</span><span style="color: #D19A66">[</span><span style="color: #E06C75">\r\t\n</span><span style="color: #D19A66">]</span><span style="color: #98C379">/</span><span style="color: #C678DD">g</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;&#39;</span><span style="color: #ABB2BF">)).</span><span style="color: #61AFEF">apply</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">options</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;jack&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">age</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">29</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">skills</span><span style="color: #ABB2BF">: [</span><span style="color: #98C379">&quot;js&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;html&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;css&quot;</span><span style="color: #ABB2BF">]</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">tpl</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;&lt;p&gt;Hello, my name is &lt;% this.name %&gt;. I</span><span style="color: #56B6C2">\&#39;</span><span style="color: #98C379">m &lt;% this.age %&gt; years old.&lt;/p&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #98C379">&#39;&lt;p&gt;My skills are &lt;% for (var index in this.skills) { %&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #98C379">&#39;&lt;a href=&quot;#&quot;&gt;&lt;% this.skills[index] %&gt;&lt;/a&gt;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #98C379">&#39;&lt;% } %&gt;&lt;/p&gt;&#39;</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">TemplateEngine</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">tpl</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 结果</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// &lt;p&gt;Hello, my name is jack. I&#39;m 29 years old.&lt;/p&gt;&lt;p&gt;My skills are &lt;a href=&quot;#&quot;&gt;js&lt;/a&gt;&lt;a href=&quot;#&quot;&gt;html&lt;/a&gt;&lt;a href=&quot;#&quot;&gt;css&lt;/a&gt;&lt;/p&gt;</span></span></code></pre>
</code></pre></div><div class=footer><hr><div class=footer-link><a href=/archive aria-label="Read more about all archives"><i class="fa fa-archive" aria-hidden=true></i> </a><a target=_blank href=https://twitter.com/chow_won aria-label="Read more on twitter"><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu aria-label="Read more on github"><i class="fa fa-github" aria-hidden=true></i> </a><a target=_blank href=mailto:zoubingwu@gmail.com aria-label=Email><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2023 zoubingwu. All rights reserved.</div></main></body></html>
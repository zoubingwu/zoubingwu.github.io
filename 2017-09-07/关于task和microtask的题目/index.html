<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>关于task和microtask的题目 | https://zoubingwu.com</title><meta property=og:title content="关于task和microtask的题目 | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content=继续上一篇的内容，来个相关的题目练练手...><meta property=og:description content=继续上一篇的内容，来个相关的题目练练手...><link rel=canonical href=https://zoubingwu.com/2017-09-07/关于task和microtask的题目><meta property=og:url content=https://zoubingwu.com/2017-09-07/关于task和microtask的题目><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2017-09-07T09:02:03.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="关于task和microtask的题目 | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script></head><body><div class=content-container><div class=post><div class=post-title>关于task和microtask的题目</div><span class=post-date><time>7 Sep 2017</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>javascript</span></a></li></ul></div><p>先来 html 结构如下：</p><pre><code class=language-html><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">div</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">class</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;outer&quot;</span><span style="color: #ABB2BF">&gt;</span></span>
<span class=line><span style="color: #ABB2BF">  &lt;</span><span style="color: #E06C75">div</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">class</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;inner&quot;</span><span style="color: #ABB2BF">&gt;&lt;/</span><span style="color: #E06C75">div</span><span style="color: #ABB2BF">&gt;</span></span>
<span class=line><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">div</span><span style="color: #ABB2BF">&gt;</span></span></code></pre>
</code></pre><p>JS代码如下，点击 <code>div.inner</code> 的时候会有什么样的结果呢？</p><p>注：关于 MutationObserver API 可以查看 <a href=https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver>MDN</a></p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// Let&#39;s get hold of those elements</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">outer</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">document</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">querySelector</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;.outer&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">inner</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">document</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">querySelector</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;.inner&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// Let&#39;s listen for attribute changes on the</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// outer element</span></span>
<span class=line><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">MutationObserver</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;mutate&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">observe</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">outer</span><span style="color: #ABB2BF">, {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">attributes</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">true</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// Here&#39;s a click listener…</span></span>
<span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">onClick</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">className</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39; is clicked&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;timeout from &#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;promise from &#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">outer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">setAttribute</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;data-random&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Math</span><span style="color: #ABB2BF">.</span><span style="color: #56B6C2">random</span><span style="color: #ABB2BF">());</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// …which we&#39;ll attach to both elements</span></span>
<span class=line><span style="color: #E5C07B">inner</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">addEventListener</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;click&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">onClick</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #E5C07B">outer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">addEventListener</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;click&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">onClick</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span></code></pre>
</code></pre><p>其实明白了上一篇文章，答案是很简单的，下面是我自己测试的结果：</p><ul><li>首先是 chrome Version 60.0.3112.113 (Official Build) (64-bit)</li></ul><p><img src=/assets/images/2017-09-07/chrome.png alt=""></p><ul><li>safari Version 10.1.2 (12603.3.8)</li></ul><p><img src=/assets/images/2017-09-07/safari.png alt=""></p><ul><li>But... in firefox 53.0.3 (64 位)</li></ul><p><img src=/assets/images/2017-09-07/firefox.png alt=""></p><p>我们来一步一步具体分析一下：</p><ol><li>点击 inner;</li><li>由于默认不使用捕获，所以先触发 inner 的 onClick 回调函数;</li><li>打印 inner is clicked;</li><li>setTimeout 将新的 task 放入队列;</li><li>promise 会将新的 microtask 放入队列;</li><li>给 outer 设置属性，触发 MutationObserver;</li><li>MutationObserver 将新的 microtask 放入队列;</li><li>回调函数中的内容结束，查看有无 microtask;</li><li>执行 5 中的内容，打印 promise from inner;</li><li>执行 7 中的内容，打印 mutate;</li><li>inner 的点击事件回调函数整个 task 结束，事件继续向上冒泡;</li><li>触发 outer 的 onClick 回调函数;</li><li>打印 outer is clicked;</li><li>setTimeout 将新的 task 放入队列;</li><li>promise 将新的 microtask 放入队列;</li><li>给 outer 再次设置属性，触发 MutationObserver;</li><li>MutationObserver 将新的 microtask 放入队列;</li><li>回调函数中的内容结束，查看有无 microtask;</li><li>执行 15 中的内容，打印 promise from outer;</li><li>执行 17 中的内容，打印 mutate;</li><li>outer 的点击事件回调函数整个 task 结束;</li><li>继续下一个 task，即 4 中的内容，打印 timeout from inner;</li><li>继续下一个 task，即 14 中的内容，打印 timeout from outer;</li><li>终于，全部结束。</li></ol><p>从这个过程我们可以看出来，microtask 如果是在回调函数中被加入的，那么执行会在回调函数的完成后马上执行，并非局限在 task 的末尾，这也是根据<a href=https://html.spec.whatwg.org/multipage/webappapis.html#calling-scripts:perform-a-microtask-checkpoint> html 文档</a>来做出的分析。</p><blockquote><p>The steps to clean up after running script with an environment settings object settings are as follows:</p><ul><li>Assert: settings&#39;s realm execution context is the running JavaScript execution context.</li><li>Remove settings&#39;s realm execution context from the JavaScript execution context stack.</li><li><strong>If the JavaScript execution context stack is now empty, perform a microtask checkpoint.</strong> (If this runs scripts, these algorithms will be invoked reentrantly.)</li></ul></blockquote><p>因此 chrome 和 safari 的结果都是符合文档的标准的，而 firefox 会将 microtask 放到 task 的末尾才开始执行，这个问题你可以在这个 <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1193394">ticket</a> 里面看看大家的讨论。</p><p>现在我们换一种方式来触发，我们在 JS 代码中最后加上一句：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">inner</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">click</span><span style="color: #ABB2BF">();</span></span></code></pre>
</code></pre><p>结果会是什么呢？</p><p>我们来再一次来一步一步分析：</p><ol><li>inner 点击事件触发;</li><li>触发 inner 的 onClick 回调函数;</li><li>打印 inner is clicked;</li><li>setTimeout 将新的 task 放入队列;</li><li>promise 会将新的 microtask 放入队列;</li><li>给 outer 设置属性，触发 MutationObserver;</li><li>MutationObserver 将新的 microtask 放入队列;</li><li>回调函数中的内容结束，但是！我们回头看看文档中的前提条件：<strong>If the JavaScript execution context stack is now empty</strong>，这个时候满足吗？并不，<code>.click()</code> 实际上和冒泡不同，会同步触发上级元素上的点击事件，因此此时 execution context stack 并不是空的，而是还需要继续执行 outer 的点击事件;</li><li>触发 outer 的 onClick 回调函数;</li><li>打印 outer is clicked;</li><li>setTimeout 将新的 task 放入队列;</li><li>promise 将新的 microtask 放入队列;</li><li>给 outer 再次设置属性，但此时第 7 步的 microtask 还在队列中未执行，因此不会再次将这个 microtask 放入队列;</li><li>回调函数中的内容结束;</li><li>开始执行 microtask;</li><li>执行 5 中的内容，打印 promise from inner;</li><li>执行 7 中的内容，打印 mutate;</li><li>继续下一个 task，即 4 中的内容，打印 timeout from inner;</li><li>继续下一个 task，即 14 中的内容，打印 timeout from outer;</li><li>终于，全部结束。</li></ol><p>因此正确的结果因该是: <code>inner is clicked</code>, <code>outer is clicked</code>, <code>promise from inner</code>, <code>mutate</code>, <code>promise from outer</code>, <code>timeout from inner</code>, <code>timeout from outer</code>。</p><h3 id=总结>总结</h3><ul><li><p>task 会按顺序进行，浏览器可能在 task 之间来渲染</p></li><li><p>microtask 也按照顺序进行，并且：</p><ul><li>要么在每一个回调函数末尾开始执行；</li><li>要么在每个 task 的末尾开始执行。</li></ul></li></ul></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2021 zoubingwu. All rights reserved.</div></div></body></html>
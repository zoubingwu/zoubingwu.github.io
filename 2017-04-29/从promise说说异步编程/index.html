<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=/assets/fonts/googlefont.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/assets/fonts/googlefont.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>从promise说说异步编程 | https://zoubingwu.com</title><meta property=og:title content="从promise说说异步编程 | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content=从axios开始说说promise的简单实现...><meta property=og:description content=从axios开始说说promise的简单实现...><link rel=canonical href=https://zoubingwu.com/2017-04-29/从promise说说异步编程><meta property=og:url content=https://zoubingwu.com/2017-04-29/从promise说说异步编程><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2017-04-29T16:46:18.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="从promise说说异步编程 | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script></head><body><div class=content-container><div class=post><div class=post-title>从promise说说异步编程</div><span class=post-date><time>29 Apr 2017</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>promise</span></a></li></ul></div><p>最近ajax请求都是使用的axios，将其包装成了一个<code>promise</code>对象，因此可以直接使用<code>then</code>和<code>catch</code>方法来代替之前的回调函数，多个并发请求也可以利用<code>all</code>来使用，非常的方便。</p><p>promise就是针对异步编程的一种解决方案，我们之前经常需要在一个异步操作结束时进行下一步的操作，而传统的方式就是进行一层一层的回调嵌套，这种代码的可读性和维护性都是很差的，<code>promise</code>就把之前基于回调函数和事件的的传统方案以同步操作的流程表达出来，这样就可以避免多重的嵌套引起的回调地狱。基本的promise用法可以参考阮一峰的<a href="http://es6.ruanyifeng.com/?search=buffer&amp;x=0&amp;y=0#docs/promise">ECMAScript 6 入门</a>。</p><p>举个关于动画的例子，我们控制一个div点击按钮1s后开始动画，分为四步，先右移100px，到达后再下移200px，然后再左移100px，上移200px回到原始位置：</p><pre><code class=language-css><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #6A737D">/* css */</span></span>
<span class=line><span style="color: #22863A">div</span><span style="color: #005CC5">#d</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">background-color</span><span style="color: #24292E">: </span><span style="color: #005CC5">red</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">transition</span><span style="color: #24292E">: </span><span style="color: #005CC5">1</span><span style="color: #D73A49">s</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">position</span><span style="color: #24292E">: </span><span style="color: #005CC5">absolute</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">width</span><span style="color: #24292E">: </span><span style="color: #005CC5">100</span><span style="color: #D73A49">px</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">height</span><span style="color: #24292E">: </span><span style="color: #005CC5">100</span><span style="color: #D73A49">px</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">left</span><span style="color: #24292E">: </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">top</span><span style="color: #24292E">: </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #8B949E">/* css */</span></span>
<span class=line><span style="color: #7EE787">div</span><span style="color: #79C0FF">#d</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">background-color</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">red</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">transition</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">1</span><span style="color: #FF7B72">s</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">position</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">absolute</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">width</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">100</span><span style="color: #FF7B72">px</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">height</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">100</span><span style="color: #FF7B72">px</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">left</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">top</span><span style="color: #C9D1D9">: </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #6A737D">//javascript</span></span>
<span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> d </span><span style="color: #D73A49">=</span><span style="color: #24292E"> document.</span><span style="color: #6F42C1">getElementById</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;d&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> btn </span><span style="color: #D73A49">=</span><span style="color: #24292E"> document.</span><span style="color: #6F42C1">getElementById</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;btn&#39;</span><span style="color: #24292E">);</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #E36209">direction</span><span style="color: #24292E">, </span><span style="color: #E36209">range</span><span style="color: #24292E">, </span><span style="color: #E36209">callback</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">    d.style[direction] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> range </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;px&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">    callback </span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">callback</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">  }, </span><span style="color: #005CC5">1000</span><span style="color: #24292E">)  ;</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">btn.</span><span style="color: #6F42C1">addEventListener</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;click&#39;</span><span style="color: #24292E">, </span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;left&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">100</span><span style="color: #24292E">, </span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;top&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">200</span><span style="color: #24292E">, </span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;left&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">, </span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;top&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">      });</span></span>
<span class=line><span style="color: #24292E">    });</span></span>
<span class=line><span style="color: #24292E">  });</span></span>
<span class=line><span style="color: #24292E">});</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #8B949E">//javascript</span></span>
<span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> d </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> document.</span><span style="color: #D2A8FF">getElementById</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;d&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> btn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> document.</span><span style="color: #D2A8FF">getElementById</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;btn&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">direction</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">range</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">callback</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">    d.style[direction] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> range </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;px&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">    callback </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">callback</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">  }, </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">)  ;</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">btn.</span><span style="color: #D2A8FF">addEventListener</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;click&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;left&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;top&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">200</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;left&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;top&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">      });</span></span>
<span class=line><span style="color: #C9D1D9">    });</span></span>
<span class=line><span style="color: #C9D1D9">  });</span></span>
<span class=line><span style="color: #C9D1D9">});</span></span></code></pre></div>
</code></pre><p>可以看到如果执行的步数有很多的话，代码就需要一层一层进行嵌套，数量多了以后就非常痛苦和丑陋了。</p><p>所以为了适合人类进行阅读，我们会希望以同步的流程表达出来，比如这样：</p><p><code>moveDivTo(...).then(...).then(...).then(...)</code></p><p>使用<code>promise</code>的话，我们就可以把代码转换成这样：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">direction</span><span style="color: #24292E">, </span><span style="color: #E36209">range</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">var</span><span style="color: #24292E"> promise </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">((</span><span style="color: #E36209">resolve</span><span style="color: #24292E">, </span><span style="color: #E36209">reject</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">      d.style[direction] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> range </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;px&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">    }, </span><span style="color: #005CC5">1000</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">  });</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> promise;</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">btn.</span><span style="color: #6F42C1">onclick</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;left&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">100</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;top&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">200</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    })</span></span>
<span class=line><span style="color: #24292E">    .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;left&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    })</span></span>
<span class=line><span style="color: #24292E">    .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;top&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    })</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">direction</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">range</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> promise </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">((</span><span style="color: #FFA657">resolve</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">reject</span><span style="color: #C9D1D9">) </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(() </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">      d.style[direction] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> range </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;px&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">    }, </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">  });</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> promise;</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">btn.</span><span style="color: #D2A8FF">onclick</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;left&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;top&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">200</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    })</span></span>
<span class=line><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;left&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    })</span></span>
<span class=line><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;top&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    })</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>为了深入理解，我们可以自己手动尝试实现一个最简单promise，这里为了简化，暂时不考虑出错的情况，我们把这个过程分为三个部分：</p><ol><li>定义构造函数</li><li>包装我们的move函数</li><li>编写then方法</li></ol><p>promise的本质是维护一个状态队列，使用内部的resolve（或reject）函数来改变状态并进行队列中的下一步：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">MyPromise</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">executor</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">var</span><span style="color: #24292E"> self </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6A737D">// 使用一个数组来存放队列</span></span>
<span class=line><span style="color: #24292E">  self.steps </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [];</span></span>
<span class=line><span style="color: #24292E">  </span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6A737D">// 通过resolve函数来执行传入的函数并设置状态</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">executor</span><span style="color: #24292E">(resolve);</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">(</span><span style="color: #E36209">value</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6A737D">// 这里因为我们不考虑状态，所以省略了self.status = &#39;resolved&#39;这一步。</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">var</span><span style="color: #24292E"> fn </span><span style="color: #D73A49">=</span><span style="color: #24292E"> self.steps.</span><span style="color: #6F42C1">shift</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">    fn </span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">fn</span><span style="color: #24292E">(value);</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">MyPromise</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">executor</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> self </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// 使用一个数组来存放队列</span></span>
<span class=line><span style="color: #C9D1D9">  self.steps </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];</span></span>
<span class=line><span style="color: #C9D1D9">  </span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #8B949E">// 通过resolve函数来执行传入的函数并设置状态</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">executor</span><span style="color: #C9D1D9">(resolve);</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">value</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 这里因为我们不考虑状态，所以省略了self.status = &#39;resolved&#39;这一步。</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> fn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> self.steps.</span><span style="color: #D2A8FF">shift</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">    fn </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">fn</span><span style="color: #C9D1D9">(value);</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>我们的move函数在包装时应该在位置的设定后执行resolve，这里其实和ES6的是一样的，为了链式的调用，需要在最后返回这个promise对象：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">direction</span><span style="color: #24292E">, </span><span style="color: #E36209">range</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">var</span><span style="color: #24292E"> promise </span><span style="color: #D73A49">=</span><span style="color: #24292E">  </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #6F42C1">MyPromise</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">resolve</span><span style="color: #24292E">){</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #005CC5">setTimeout</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">      d.style[direction] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> range </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;px&#39;</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #6F42C1">resolve</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">    }, </span><span style="color: #005CC5">1000</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">  });</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> promise;</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">direction</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">range</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> promise </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">MyPromise</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">resolve</span><span style="color: #C9D1D9">){</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">setTimeout</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">      d.style[direction] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> range </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;px&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">resolve</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">    }, </span><span style="color: #79C0FF">1000</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">  });</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> promise;</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>then方法我们直接定义在原型对象上，因为不考虑其他情况，直接把then方法传入的回调函数放入队列之中，同样then方法返回的是一个新的promise，</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #005CC5">MyPromise</span><span style="color: #24292E">.</span><span style="color: #005CC5">prototype</span><span style="color: #24292E">.</span><span style="color: #6F42C1">then</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">func</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">var</span><span style="color: #24292E"> self </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">resolve</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    self.steps.</span><span style="color: #6F42C1">push</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">value</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">var</span><span style="color: #24292E"> x </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">func</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #6A737D">// 如果返回的是一个promise对象，执行then方法传入resolve</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (x </span><span style="color: #D73A49">instanceof</span><span style="color: #24292E"> </span><span style="color: #E36209">MyPromise</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">        x.</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(resolve);</span></span>
<span class=line><span style="color: #24292E">      }</span></span>
<span class=line><span style="color: #24292E">    });</span></span>
<span class=line><span style="color: #24292E">  });</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #79C0FF">MyPromise</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">prototype</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">func</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> self </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Promise</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">resolve</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    self.steps.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">value</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> x </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">func</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// 如果返回的是一个promise对象，执行then方法传入resolve</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (x </span><span style="color: #FF7B72">instanceof</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">MyPromise</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">        x.</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(resolve);</span></span>
<span class=line><span style="color: #C9D1D9">      }</span></span>
<span class=line><span style="color: #C9D1D9">    });</span></span>
<span class=line><span style="color: #C9D1D9">  });</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>最后使用我们自己定义的MyPromise:</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #24292E">btn.</span><span style="color: #6F42C1">onclick</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;left&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">100</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;top&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">200</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    })</span></span>
<span class=line><span style="color: #24292E">    .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;left&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    })</span></span>
<span class=line><span style="color: #24292E">    .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(){</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">moveDivTo</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;top&#39;</span><span style="color: #24292E">, </span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    })</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #C9D1D9">btn.</span><span style="color: #D2A8FF">onclick</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;left&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">100</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;top&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">200</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    })</span></span>
<span class=line><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;left&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    })</span></span>
<span class=line><span style="color: #C9D1D9">    .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(){</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">moveDivTo</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;top&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    })</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2021 zoubingwu. All rights reserved.</div></div></body></html>
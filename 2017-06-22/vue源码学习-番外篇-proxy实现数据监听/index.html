<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=/assets/fonts/googlefont.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/assets/fonts/googlefont.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>Vue源码学习-番外篇-proxy实现数据监听 | https://zoubingwu.com</title><meta property=og:title content="Vue源码学习-番外篇-proxy实现数据监听 | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content=尝试利用ES6的Proxy特性实现数据的变化监听...><meta property=og:description content=尝试利用ES6的Proxy特性实现数据的变化监听...><link rel=canonical href=https://zoubingwu.com/2017-06-22/vue源码学习-番外篇-proxy实现数据监听><meta property=og:url content=https://zoubingwu.com/2017-06-22/vue源码学习-番外篇-proxy实现数据监听><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2017-06-22T20:15:27.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="Vue源码学习-番外篇-proxy实现数据监听 | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script></head><body><div class=content-container><div class=post><div class=post-title>Vue源码学习-番外篇-proxy实现数据监听</div><span class=post-date><time>22 Jun 2017</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>vue</span></a></li></ul></div><p><code>proxy</code>在中文里往往翻译成代理的意思，在JS中，它可以在对象间架设一层中间层，访问一个对象时需要先通过这一层：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> obj </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Proxy</span><span style="color: #24292E">({}, {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">get</span><span style="color: #24292E">: </span><span style="color: #D73A49">function</span><span style="color: #24292E"> (</span><span style="color: #E36209">target</span><span style="color: #24292E">, </span><span style="color: #E36209">key</span><span style="color: #24292E">, </span><span style="color: #E36209">receiver</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`getting ${</span><span style="color: #24292E">key</span><span style="color: #032F62">}!`</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">Reflect</span><span style="color: #24292E">.</span><span style="color: #6F42C1">get</span><span style="color: #24292E">(target, key, receiver);</span></span>
<span class=line><span style="color: #24292E">  },</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">set</span><span style="color: #24292E">: </span><span style="color: #D73A49">function</span><span style="color: #24292E"> (</span><span style="color: #E36209">target</span><span style="color: #24292E">, </span><span style="color: #E36209">key</span><span style="color: #24292E">, </span><span style="color: #E36209">value</span><span style="color: #24292E">, </span><span style="color: #E36209">receiver</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`setting ${</span><span style="color: #24292E">key</span><span style="color: #032F62">}!`</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">Reflect</span><span style="color: #24292E">.</span><span style="color: #6F42C1">set</span><span style="color: #24292E">(target, key, value, receiver);</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">});</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> obj </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Proxy</span><span style="color: #C9D1D9">({}, {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">target</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">key</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">receiver</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`getting ${</span><span style="color: #C9D1D9">key</span><span style="color: #A5D6FF">}!`</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Reflect</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(target, key, receiver);</span></span>
<span class=line><span style="color: #C9D1D9">  },</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">set</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> (</span><span style="color: #FFA657">target</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">key</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">value</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">receiver</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`setting ${</span><span style="color: #C9D1D9">key</span><span style="color: #A5D6FF">}!`</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Reflect</span><span style="color: #C9D1D9">.</span><span style="color: #D2A8FF">set</span><span style="color: #C9D1D9">(target, key, value, receiver);</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">});</span></span></code></pre></div>
</code></pre><p>可以看到和我们之前使用<code>Object.defineProperty</code>来实现数据绑定很相似。</p><p><code>Proxy</code>是ES6中的新特性，它非常强大，但这里我们不详细解释，更多关于Proxy的内容可以参考<a href="http://es6.ruanyifeng.com/?search=...&amp;x=3&amp;y=10#docs/proxy">这里</a>。</p><p>首先我们来试一下简单的数据类型：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">person</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">      name: </span><span style="color: #032F62">&#39;jack&#39;</span><span style="color: #24292E">,</span></span>
<span class=line><span style="color: #24292E">      age: </span><span style="color: #005CC5">25</span><span style="color: #24292E">,</span></span>
<span class=line><span style="color: #24292E">      info: {</span></span>
<span class=line><span style="color: #24292E">        prof: </span><span style="color: #032F62">&#39;teacher&#39;</span><span style="color: #24292E">,</span></span>
<span class=line><span style="color: #24292E">        city: </span><span style="color: #032F62">&#39;beijng&#39;</span></span>
<span class=line><span style="color: #24292E">      }</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">observer</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #E36209">data</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Proxy</span><span style="color: #24292E">(data, {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">get</span><span style="color: #24292E">(</span><span style="color: #E36209">target</span><span style="color: #24292E">, </span><span style="color: #E36209">prop</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`getting the ${</span><span style="color: #24292E">prop</span><span style="color: #032F62">}`</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> target[prop]</span></span>
<span class=line><span style="color: #24292E">  },</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">set</span><span style="color: #24292E">(</span><span style="color: #E36209">target</span><span style="color: #24292E">, </span><span style="color: #E36209">prop</span><span style="color: #24292E">, </span><span style="color: #E36209">value</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`setting the ${</span><span style="color: #24292E">prop</span><span style="color: #032F62">} to ${</span><span style="color: #24292E">value</span><span style="color: #032F62">}`</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    target[prop] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> value</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">})</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">let</span><span style="color: #24292E"> proxy </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">observer</span><span style="color: #24292E">(person)</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">person</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">      name: </span><span style="color: #A5D6FF">&#39;jack&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class=line><span style="color: #C9D1D9">      age: </span><span style="color: #79C0FF">25</span><span style="color: #C9D1D9">,</span></span>
<span class=line><span style="color: #C9D1D9">      info: {</span></span>
<span class=line><span style="color: #C9D1D9">        prof: </span><span style="color: #A5D6FF">&#39;teacher&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class=line><span style="color: #C9D1D9">        city: </span><span style="color: #A5D6FF">&#39;beijng&#39;</span></span>
<span class=line><span style="color: #C9D1D9">      }</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">observer</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">data</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Proxy</span><span style="color: #C9D1D9">(data, {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">target</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">prop</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`getting the ${</span><span style="color: #C9D1D9">prop</span><span style="color: #A5D6FF">}`</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> target[prop]</span></span>
<span class=line><span style="color: #C9D1D9">  },</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">set</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">target</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">prop</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">value</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`setting the ${</span><span style="color: #C9D1D9">prop</span><span style="color: #A5D6FF">} to ${</span><span style="color: #C9D1D9">value</span><span style="color: #A5D6FF">}`</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    target[prop] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> value</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">})</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> proxy </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">observer</span><span style="color: #C9D1D9">(person)</span></span></code></pre></div>
</code></pre><p>效果如图：</p><p><img src=/assets/images/2017-06-22-Vue%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-%E7%95%AA%E5%A4%96%E7%AF%87-proxy%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E7%9B%91%E5%90%AC/1.gif alt=1.gif></p><p>可以看到这个效果和我们之前所使用的<code>Object.defineProperty</code>所达成的是一样的。那么对于属性的值为数组和对象的复杂类型呢？</p><p>直接按上述的代码中的<code>Proxy</code>实例来操作属性其实是不行的，但是我们可以对数组或对象类型的属性也代理一层：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">person</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">  name: </span><span style="color: #032F62">&#39;jack&#39;</span><span style="color: #24292E">,</span></span>
<span class=line><span style="color: #24292E">  age: </span><span style="color: #005CC5">25</span><span style="color: #24292E">,</span></span>
<span class=line><span style="color: #24292E">  info: {</span></span>
<span class=line><span style="color: #24292E">    prof: </span><span style="color: #032F62">&#39;teacher&#39;</span><span style="color: #24292E">,</span></span>
<span class=line><span style="color: #24292E">    city: </span><span style="color: #032F62">&#39;beijng&#39;</span></span>
<span class=line><span style="color: #24292E">  },</span></span>
<span class=line><span style="color: #24292E">  children: [</span><span style="color: #032F62">&#39;lucy&#39;</span><span style="color: #24292E">, </span><span style="color: #032F62">&#39;lily&#39;</span><span style="color: #24292E">, </span><span style="color: #032F62">&#39;luc&#39;</span><span style="color: #24292E">]</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">observer</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #E36209">data</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #D73A49">new</span><span style="color: #24292E"> </span><span style="color: #005CC5">Proxy</span><span style="color: #24292E">(data, {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">get</span><span style="color: #24292E">(</span><span style="color: #E36209">target</span><span style="color: #24292E">, </span><span style="color: #E36209">prop</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`getting the ${</span><span style="color: #24292E">prop</span><span style="color: #032F62">}`</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> target[prop]</span></span>
<span class=line><span style="color: #24292E">  },</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">set</span><span style="color: #24292E">(</span><span style="color: #E36209">target</span><span style="color: #24292E">, </span><span style="color: #E36209">prop</span><span style="color: #24292E">, </span><span style="color: #E36209">value</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`setting the ${</span><span style="color: #24292E">prop</span><span style="color: #032F62">} to ${</span><span style="color: #24292E">value</span><span style="color: #032F62">}`</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    target[prop] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> value</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6A737D">// 注意这里返回的true</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span></span>
<span class=line><span style="color: #24292E">  },</span></span>
<span class=line><span style="color: #24292E">})</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">let</span><span style="color: #24292E"> proxy </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">observer</span><span style="color: #24292E">(person)</span></span>
<span class=line><span style="color: #D73A49">let</span><span style="color: #24292E"> proxyChildren </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">observer</span><span style="color: #24292E">(person.children)</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">person</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">  name: </span><span style="color: #A5D6FF">&#39;jack&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class=line><span style="color: #C9D1D9">  age: </span><span style="color: #79C0FF">25</span><span style="color: #C9D1D9">,</span></span>
<span class=line><span style="color: #C9D1D9">  info: {</span></span>
<span class=line><span style="color: #C9D1D9">    prof: </span><span style="color: #A5D6FF">&#39;teacher&#39;</span><span style="color: #C9D1D9">,</span></span>
<span class=line><span style="color: #C9D1D9">    city: </span><span style="color: #A5D6FF">&#39;beijng&#39;</span></span>
<span class=line><span style="color: #C9D1D9">  },</span></span>
<span class=line><span style="color: #C9D1D9">  children: [</span><span style="color: #A5D6FF">&#39;lucy&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&#39;lily&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&#39;luc&#39;</span><span style="color: #C9D1D9">]</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">observer</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FFA657">data</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">new</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Proxy</span><span style="color: #C9D1D9">(data, {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">get</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">target</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">prop</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`getting the ${</span><span style="color: #C9D1D9">prop</span><span style="color: #A5D6FF">}`</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> target[prop]</span></span>
<span class=line><span style="color: #C9D1D9">  },</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">set</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">target</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">prop</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">value</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">`setting the ${</span><span style="color: #C9D1D9">prop</span><span style="color: #A5D6FF">} to ${</span><span style="color: #C9D1D9">value</span><span style="color: #A5D6FF">}`</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    target[prop] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> value</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// 注意这里返回的true</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">true</span></span>
<span class=line><span style="color: #C9D1D9">  },</span></span>
<span class=line><span style="color: #C9D1D9">})</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> proxy </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">observer</span><span style="color: #C9D1D9">(person)</span></span>
<span class=line><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> proxyChildren </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">observer</span><span style="color: #C9D1D9">(person.children)</span></span></code></pre></div>
</code></pre><p>此时我们对<code>proxyChildren</code>进行操作，也是可以实现对数据的监听：</p><p><img src=/assets/images/2017-06-22-Vue%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-%E7%95%AA%E5%A4%96%E7%AF%87-proxy%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E7%9B%91%E5%90%AC/2.gif alt=2.gif></p><p>值得注意的是，之前如果set函数没有返回一个<code>true</code>值，那么会抛出<code>TypeError: &#39;set&#39; on proxy: trap returned falsish for property &#39;3&#39;</code>错误，<a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/set>MDN</a>上对这一点其实有记录：</p><blockquote><h3 id=return-value>Return value</h3><p>The <code>set</code> method should return a boolean value. Return <code>true</code> to indicate that assignment succeeded. If the <code>set</code> method returns <code>false</code>, and the assignment happened in strict-mode code, a <code>TypeError</code> will be thrown.</p></blockquote><h3 id=总结>总结</h3><p>结合上述的代码，我们已经可以使用<code>proxy</code>来拦截一个对象的属性，以达成数据监听的目的，对于它的属性为复杂类型时，也只需要再次将其包装为一个<code>proxy</code>实例。</p><p>下一篇我们再继续深入来尝试实现数据和视图的双向绑定。</p></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2021 zoubingwu. All rights reserved.</div></div></body></html>
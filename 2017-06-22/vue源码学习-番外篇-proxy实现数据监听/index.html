<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=stylesheet href=/assets/fonts/font-awesome.min.css type=text/css><link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300;1,700&display=swap" rel=stylesheet><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>Vue源码学习-番外篇-proxy实现数据监听 | https://zoubingwu.com</title><meta property=og:title content="Vue源码学习-番外篇-proxy实现数据监听 | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content=尝试利用ES6的Proxy特性实现数据的变化监听...><meta property=og:description content=尝试利用ES6的Proxy特性实现数据的变化监听...><link rel=canonical href=https://zoubingwu.com/2017-06-22/vue源码学习-番外篇-proxy实现数据监听><meta property=og:url content=https://zoubingwu.com/2017-06-22/vue源码学习-番外篇-proxy实现数据监听><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2017-06-22T20:15:27.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="Vue源码学习-番外篇-proxy实现数据监听 | https://zoubingwu.com"><script defer=defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "76b8468271b24f3180af2110f74841c3"}'></script></head><body><main class=content-container><div class=post><div class=post-title>Vue源码学习-番外篇-proxy实现数据监听</div><span class=post-date><time>22 Jun 2017</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>vue</span></a></li></ul></div><p><code>proxy</code>在中文里往往翻译成代理的意思，在JS中，它可以在对象间架设一层中间层，访问一个对象时需要先通过这一层：</p><pre><code class=language-javascript><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">obj</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Proxy</span><span style="color: #ABB2BF">({}, {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">target</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">key</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">receiver</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">`getting </span><span style="color: #C678DD">${</span><span style="color: #E06C75">key</span><span style="color: #C678DD">}</span><span style="color: #98C379">!`</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Reflect</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">target</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">receiver</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  },</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">set</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">target</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">key</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">value</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">receiver</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">`setting </span><span style="color: #C678DD">${</span><span style="color: #E06C75">key</span><span style="color: #C678DD">}</span><span style="color: #98C379">!`</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Reflect</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">set</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">target</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">value</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">receiver</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>可以看到和我们之前使用<code>Object.defineProperty</code>来实现数据绑定很相似。</p><p><code>Proxy</code>是ES6中的新特性，它非常强大，但这里我们不详细解释，更多关于Proxy的内容可以参考<a href="http://es6.ruanyifeng.com/?search=...&amp;x=3&amp;y=10#docs/proxy">这里</a>。</p><p>首先我们来试一下简单的数据类型：</p><pre><code class=language-javascript><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">person</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;jack&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E06C75">age</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">25</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E06C75">info</span><span style="color: #ABB2BF">: {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E06C75">prof</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;teacher&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E06C75">city</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;beijng&#39;</span></span>
<span class=line><span style="color: #ABB2BF">      }</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">observer</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Proxy</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">, {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">target</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">prop</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">`getting the </span><span style="color: #C678DD">${</span><span style="color: #E06C75">prop</span><span style="color: #C678DD">}</span><span style="color: #98C379">`</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">target</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">prop</span><span style="color: #ABB2BF">]</span></span>
<span class=line><span style="color: #ABB2BF">  },</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">set</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">target</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">prop</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">value</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">`setting the </span><span style="color: #C678DD">${</span><span style="color: #E06C75">prop</span><span style="color: #C678DD">}</span><span style="color: #98C379"> to </span><span style="color: #C678DD">${</span><span style="color: #E06C75">value</span><span style="color: #C678DD">}</span><span style="color: #98C379">`</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">target</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">prop</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">value</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">})</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">proxy</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">observer</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">person</span><span style="color: #ABB2BF">)</span></span></code></pre>
</code></pre><p>效果如图：</p><p><img src=/assets/images/2017-06-22-Vue%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-%E7%95%AA%E5%A4%96%E7%AF%87-proxy%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E7%9B%91%E5%90%AC/1.gif alt=1.gif></p><p>可以看到这个效果和我们之前所使用的<code>Object.defineProperty</code>所达成的是一样的。那么对于属性的值为数组和对象的复杂类型呢？</p><p>直接按上述的代码中的<code>Proxy</code>实例来操作属性其实是不行的，但是我们可以对数组或对象类型的属性也代理一层：</p><pre><code class=language-javascript><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">person</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;jack&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">age</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">25</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">info</span><span style="color: #ABB2BF">: {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">prof</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;teacher&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">city</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;beijng&#39;</span></span>
<span class=line><span style="color: #ABB2BF">  },</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">children</span><span style="color: #ABB2BF">: [</span><span style="color: #98C379">&#39;lucy&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;lily&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;luc&#39;</span><span style="color: #ABB2BF">]</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">observer</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Proxy</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">, {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">target</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">prop</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">`getting the </span><span style="color: #C678DD">${</span><span style="color: #E06C75">prop</span><span style="color: #C678DD">}</span><span style="color: #98C379">`</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">target</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">prop</span><span style="color: #ABB2BF">]</span></span>
<span class=line><span style="color: #ABB2BF">  },</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">set</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">target</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">prop</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">value</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">`setting the </span><span style="color: #C678DD">${</span><span style="color: #E06C75">prop</span><span style="color: #C678DD">}</span><span style="color: #98C379"> to </span><span style="color: #C678DD">${</span><span style="color: #E06C75">value</span><span style="color: #C678DD">}</span><span style="color: #98C379">`</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">target</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">prop</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">value</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// 注意这里返回的true</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span></span>
<span class=line><span style="color: #ABB2BF">  },</span></span>
<span class=line><span style="color: #ABB2BF">})</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">proxy</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">observer</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">person</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">proxyChildren</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">observer</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">person</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">children</span><span style="color: #ABB2BF">)</span></span></code></pre>
</code></pre><p>此时我们对<code>proxyChildren</code>进行操作，也是可以实现对数据的监听：</p><p><img src=/assets/images/2017-06-22-Vue%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-%E7%95%AA%E5%A4%96%E7%AF%87-proxy%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E7%9B%91%E5%90%AC/2.gif alt=2.gif></p><p>值得注意的是，之前如果set函数没有返回一个<code>true</code>值，那么会抛出<code>TypeError: &#39;set&#39; on proxy: trap returned falsish for property &#39;3&#39;</code>错误，<a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/set>MDN</a>上对这一点其实有记录：</p><blockquote><h3 id=return-value>Return value</h3><p>The <code>set</code> method should return a boolean value. Return <code>true</code> to indicate that assignment succeeded. If the <code>set</code> method returns <code>false</code>, and the assignment happened in strict-mode code, a <code>TypeError</code> will be thrown.</p></blockquote><h3 id=总结>总结</h3><p>结合上述的代码，我们已经可以使用<code>proxy</code>来拦截一个对象的属性，以达成数据监听的目的，对于它的属性为复杂类型时，也只需要再次将其包装为一个<code>proxy</code>实例。</p><p>下一篇我们再继续深入来尝试实现数据和视图的双向绑定。</p></div><div class=footer><hr><div class=footer-link><a href=/archive aria-label="Read more about all archives"><i class="fa fa-archive" aria-hidden=true></i> </a><a target=_blank href=https://twitter.com/chow_won aria-label="Read more on twitter"><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu aria-label="Read more on github"><i class="fa fa-github" aria-hidden=true></i> </a><a target=_blank href=mailto:zoubingwu@gmail.com aria-label=Email><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2023 zoubingwu. All rights reserved.</div></main></body></html>
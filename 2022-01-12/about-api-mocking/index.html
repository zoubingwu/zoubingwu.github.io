<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=stylesheet href=/assets/fonts/font-awesome.min.css type=text/css><link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300;1,700&display=swap" rel=stylesheet><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>about API mocking | https://zoubingwu.com</title><meta property=og:title content="about API mocking | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content="Elegant API mocking with the service worker."><meta property=og:description content="Elegant API mocking with the service worker."><link rel=canonical href=https://zoubingwu.com/2022-01-12/about-api-mocking><meta property=og:url content=https://zoubingwu.com/2022-01-12/about-api-mocking><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2022-01-12T20:04:33.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="about API mocking | https://zoubingwu.com"><script defer=defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "76b8468271b24f3180af2110f74841c3"}'></script></head><body><main class=content-container><div class=post><div class=post-title>about API mocking</div><span class=post-date><time>12 Jan 2022</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>js</span></a></li><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>mock</span></a></li></ul></div><p>When building a front-end project, you often need to mock an API call yourself in many scenarios:</p><ul><li>in an agile, competitive environment, the backend may be still developing, and you hope to be able to build front-end in parallel</li><li>Or in the development environment, the backend server is quite unstable, and waiting for them to fix it is not an option.</li><li>Most of the front-end issues are related to the data, such as invalid API calls, missing error handling, or something like a text is too long to display and needs to be truncated.</li><li>Sometimes, you want to be able to quickly carry out some experimental development, such as experimenting with a new technology or the prototype implementation of some ideas</li></ul><p>Generally speaking, the possible ways include static fixtures, hand-writing code, or some third-party dependencies. For example, create another independent server and pass all the requests to that server. These methods are not particularly ideal.</p><p>It needs us to modify the code repeatedly when using the hard-coded state, and introducing a new server will bring new maintenance burdens. Not only do you need to start an additional process on the command line, but also you may need to frequently switch proxy target to forward the request to the correct server endpoint. This indeed works but definitely is not an ideal and smooth development pattern. So is there a perfect way to meet our needs?</p><p>There is a library called <a href=https://github.com/mswjs/msw>msw</a> which did a very good job. It uses the service worker to intercept all requests on the network level to mock every call, and it is very easy to use. You only have to worry about how to define your data, and the rest will be handled by it.</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// mock.js</span></span>
<span class=line><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> { </span><span style="color: #E06C75">setupWorker</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">rest</span><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;msw&#39;</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">export</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">worker</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">setupWorker</span><span style="color: #ABB2BF">(</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">rest</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">post</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;/login&#39;</span><span style="color: #ABB2BF">, (</span><span style="color: #E06C75; font-style: italic">req</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">res</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">ctx</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">ctx</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">({</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E06C75">firstName</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;John&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">    })</span></span>
<span class=line><span style="color: #ABB2BF">  }),</span></span>
<span class=line><span style="color: #ABB2BF">)</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// index.js</span></span>
<span class=line><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">NODE_ENV</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;mock&#39;</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> { </span><span style="color: #E5C07B">worker</span><span style="color: #ABB2BF"> } </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">require</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;./mock&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">worker</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">start</span><span style="color: #ABB2BF">()</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>In this way, you don&#39;t need to modify any business code to adapt to it. Instead, you only need to inject different environment variables when starting the dev server to achieve seamless use of mock data.</p><p>But then writing mock data for every request becomes troublesome work. The shape of mocking data for each API needs to conform to the convention you have with the backend server. Tools like swagger are widely used in the backend to generate documentation as a role of such convention. One of those convention formats is called <a href=https://swagger.io/specification/ >OpenAPI</a>. With OpenAPI specification, now we know every request about what kind of data they will need what kind of data they will return.</p><p>So instead of hand-writing everything, it is much wiser to take advantage of the existing conventions like OpenAPI. I wrote a simple CLI tool called <a href=https://github.com/zoubingwu/msw-auto-mock>msw-auto-mock</a> to help us to generate the correct shape of mock data automatically by reading required information from the specification.</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">npx msw-auto-mock http://your_openapi.json -o ./mock.js</span></span></code></pre>
</code></pre><p>With one command, you can have complete random mock definitions for your API. Then you can use the generated code anywhere you need.</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> { </span><span style="color: #E06C75">startWorker</span><span style="color: #ABB2BF"> } </span><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;./mock&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">NODE_ENV</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;development&#39;</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">startWorker</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre></div><div class=footer><hr><div class=footer-link><a href=/archive aria-label="Read more about all archives"><i class="fa fa-archive" aria-hidden=true></i> </a><a target=_blank href=https://twitter.com/chow_won aria-label="Read more on twitter"><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu aria-label="Read more on github"><i class="fa fa-github" aria-hidden=true></i> </a><a target=_blank href=mailto:zoubingwu@gmail.com aria-label=Email><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2023 zoubingwu. All rights reserved.</div></main></body></html>
<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=/assets/fonts/googlefont.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/assets/fonts/googlefont.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>Flatten Go-like promise to avoid try catch hell | https://zoubingwu.com</title><meta property=og:title content="Flatten Go-like promise to avoid try catch hell | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content="A interesting Go-like pattern to avoid try/catch hell in async/await."><meta property=og:description content="A interesting Go-like pattern to avoid try/catch hell in async/await."><link rel=canonical href=https://zoubingwu.com/2018-04-24/flatten-go-like-promise-to-avoid-try-catch-hell><meta property=og:url content=https://zoubingwu.com/2018-04-24/flatten-go-like-promise-to-avoid-try-catch-hell><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2018-04-24T14:29:31.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="Flatten Go-like promise to avoid try catch hell | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script></head><body><div class=content-container><div class=post><div class=post-title>Flatten Go-like promise to avoid try catch hell</div><span class=post-date><time>24 Apr 2018</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>javascript</span></a></li><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>promise</span></a></li></ul></div><h2 id=intro>Intro</h2><p>异步代码从最早的 callback hell，到现在的 ES7 我们已经可以用 async/await 来像编写同步代码一样优雅的编写了。</p><p>什么是回调地狱（callback hell）呢，看下面的代码就一目了然了：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">AsyncTask</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">   </span><span style="color: #6F42C1">asyncFuncA</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">err</span><span style="color: #24292E">, </span><span style="color: #E36209">resultA</span><span style="color: #24292E">){</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E">(err) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(err);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #6F42C1">asyncFuncB</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">err</span><span style="color: #24292E">, </span><span style="color: #E36209">resultB</span><span style="color: #24292E">){</span></span>
<span class=line><span style="color: #24292E">         </span><span style="color: #D73A49">if</span><span style="color: #24292E">(err) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(err);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">          </span><span style="color: #6F42C1">asyncFuncC</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">err</span><span style="color: #24292E">, </span><span style="color: #E36209">resultC</span><span style="color: #24292E">){</span></span>
<span class=line><span style="color: #24292E">               </span><span style="color: #D73A49">if</span><span style="color: #24292E">(err) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(err);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">               </span><span style="color: #6A737D">// And so it goes....</span></span>
<span class=line><span style="color: #24292E">          });</span></span>
<span class=line><span style="color: #24292E">      });</span></span>
<span class=line><span style="color: #24292E">   });</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">AsyncTask</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">   </span><span style="color: #D2A8FF">asyncFuncA</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">err</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">resultA</span><span style="color: #C9D1D9">){</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(err) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(err);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #D2A8FF">asyncFuncB</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">err</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">resultB</span><span style="color: #C9D1D9">){</span></span>
<span class=line><span style="color: #C9D1D9">         </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(err) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(err);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">          </span><span style="color: #D2A8FF">asyncFuncC</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">err</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">resultC</span><span style="color: #C9D1D9">){</span></span>
<span class=line><span style="color: #C9D1D9">               </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(err) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(err);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">               </span><span style="color: #8B949E">// And so it goes....</span></span>
<span class=line><span style="color: #C9D1D9">          });</span></span>
<span class=line><span style="color: #C9D1D9">      });</span></span>
<span class=line><span style="color: #C9D1D9">   });</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>这样的代码可读性和维护性都非常差，后来社区又引入了 promise：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncTask</span><span style="color: #24292E">(</span><span style="color: #E36209">cb</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">   asyncFuncA.</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(AsyncFuncB)</span></span>
<span class=line><span style="color: #24292E">      .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(AsyncFuncC)</span></span>
<span class=line><span style="color: #24292E">      .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(AsyncFuncD)</span></span>
<span class=line><span style="color: #24292E">      .</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #E36209">data</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #005CC5">null</span><span style="color: #24292E">, data)</span></span>
<span class=line><span style="color: #24292E">      .</span><span style="color: #6F42C1">catch</span><span style="color: #24292E">(</span><span style="color: #E36209">err</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(err));</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncTask</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">cb</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">   asyncFuncA.</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(AsyncFuncB)</span></span>
<span class=line><span style="color: #C9D1D9">      .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(AsyncFuncC)</span></span>
<span class=line><span style="color: #C9D1D9">      .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(AsyncFuncD)</span></span>
<span class=line><span style="color: #C9D1D9">      .</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">data</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">, data)</span></span>
<span class=line><span style="color: #C9D1D9">      .</span><span style="color: #D2A8FF">catch</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">err</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(err));</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>这样看上去确实是干净多了，但实际的开发中写多了会发现非常复杂的异步情况时，大量的 then 写起来还是有点累赘，而且很多时候的流程控制并非像这样线性的考虑，可能会出现很多分支。</p><p>ES7 终于推出了 async/await 标准，虽然浏览器并不直接支持，但我们使用 babel transpiler 或者 typescript 都可以享受这一特性。</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncTask</span><span style="color: #24292E">(</span><span style="color: #E36209">cb</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">user</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> UserModel.</span><span style="color: #6F42C1">findById</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E">(</span><span style="color: #D73A49">!</span><span style="color: #24292E">user) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;No user found&#39;</span><span style="color: #24292E">);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">savedTask</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">TaskModel</span><span style="color: #24292E">({userId: user.id, name: </span><span style="color: #032F62">&#39;Demo Task&#39;</span><span style="color: #24292E">});</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E">(user.notificationsEnabled) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">await</span><span style="color: #24292E"> NotificationService.</span><span style="color: #6F42C1">sendNotification</span><span style="color: #24292E">(user.id, </span><span style="color: #032F62">&#39;Task Created&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E">(savedTask.assignedUser.id </span><span style="color: #D73A49">!==</span><span style="color: #24292E"> user.id) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">await</span><span style="color: #24292E"> NotificationService.</span><span style="color: #6F42C1">sendNotification</span><span style="color: #24292E">(savedTask.assignedUser.id, </span><span style="color: #032F62">&#39;Task was created for you&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #005CC5">null</span><span style="color: #24292E">, savedTask);</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncTask</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">cb</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">user</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> UserModel.</span><span style="color: #D2A8FF">findById</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">user) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;No user found&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">savedTask</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">TaskModel</span><span style="color: #C9D1D9">({userId: user.id, name: </span><span style="color: #A5D6FF">&#39;Demo Task&#39;</span><span style="color: #C9D1D9">});</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(user.notificationsEnabled) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> NotificationService.</span><span style="color: #D2A8FF">sendNotification</span><span style="color: #C9D1D9">(user.id, </span><span style="color: #A5D6FF">&#39;Task Created&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(savedTask.assignedUser.id </span><span style="color: #FF7B72">!==</span><span style="color: #C9D1D9"> user.id) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> NotificationService.</span><span style="color: #D2A8FF">sendNotification</span><span style="color: #C9D1D9">(savedTask.assignedUser.id, </span><span style="color: #A5D6FF">&#39;Task was created for you&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">, savedTask);</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>同样的还有基于 Generator 的解决方案：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">*function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncTask</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">task1</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">task2</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">task3</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">yield</span><span style="color: #24292E"> </span><span style="color: #6F42C1">task4</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">*function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncTask</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">task1</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">task2</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">task3</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">yield</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">task4</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>可以看到我们编写异步代码简直和同步代码几乎没有什么区别。代码看上去也干净利落，但有一个问题是，如果需要处理异步调用中的错误情况的话，只能使用 try catch，导致生产中我们的代码可能变成这样：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncTask</span><span style="color: #24292E">(</span><span style="color: #E36209">cb</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">       </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">user</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> UserModel.</span><span style="color: #6F42C1">findById</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">       </span><span style="color: #D73A49">if</span><span style="color: #24292E">(</span><span style="color: #D73A49">!</span><span style="color: #24292E">user) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;No user found&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    } </span><span style="color: #D73A49">catch</span><span style="color: #24292E">(e) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;Unexpected error occurred&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">       </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">savedTask</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">TaskModel</span><span style="color: #24292E">({userId: user.id, name: </span><span style="color: #032F62">&#39;Demo Task&#39;</span><span style="color: #24292E">});</span></span>
<span class=line><span style="color: #24292E">    } </span><span style="color: #D73A49">catch</span><span style="color: #24292E">(e) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;Error occurred while saving task&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E">(user.notificationsEnabled) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">            </span><span style="color: #D73A49">await</span><span style="color: #24292E"> NotificationService.</span><span style="color: #6F42C1">sendNotification</span><span style="color: #24292E">(user.id, </span><span style="color: #032F62">&#39;Task Created&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">        } </span><span style="color: #D73A49">catch</span><span style="color: #24292E">(e) {</span></span>
<span class=line><span style="color: #24292E">            </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;Error while sending notification&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">        }</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E">(savedTask.assignedUser.id </span><span style="color: #D73A49">!==</span><span style="color: #24292E"> user.id) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">try</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">            </span><span style="color: #D73A49">await</span><span style="color: #24292E"> NotificationService.</span><span style="color: #6F42C1">sendNotification</span><span style="color: #24292E">(savedTask.assignedUser.id, </span><span style="color: #032F62">&#39;Task was created for you&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">        } </span><span style="color: #D73A49">catch</span><span style="color: #24292E">(e) {</span></span>
<span class=line><span style="color: #24292E">            </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;Error while sending notification&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">        }</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #005CC5">null</span><span style="color: #24292E">, savedTask);</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncTask</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">cb</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">       </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">user</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> UserModel.</span><span style="color: #D2A8FF">findById</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">       </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">user) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;No user found&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9">(e) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;Unexpected error occurred&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">       </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">savedTask</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">TaskModel</span><span style="color: #C9D1D9">({userId: user.id, name: </span><span style="color: #A5D6FF">&#39;Demo Task&#39;</span><span style="color: #C9D1D9">});</span></span>
<span class=line><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9">(e) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;Error occurred while saving task&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(user.notificationsEnabled) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> NotificationService.</span><span style="color: #D2A8FF">sendNotification</span><span style="color: #C9D1D9">(user.id, </span><span style="color: #A5D6FF">&#39;Task Created&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">        } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9">(e) {</span></span>
<span class=line><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;Error while sending notification&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">        }</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(savedTask.assignedUser.id </span><span style="color: #FF7B72">!==</span><span style="color: #C9D1D9"> user.id) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">try</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> NotificationService.</span><span style="color: #D2A8FF">sendNotification</span><span style="color: #C9D1D9">(savedTask.assignedUser.id, </span><span style="color: #A5D6FF">&#39;Task was created for you&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">        } </span><span style="color: #FF7B72">catch</span><span style="color: #C9D1D9">(e) {</span></span>
<span class=line><span style="color: #C9D1D9">            </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;Error while sending notification&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">        }</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">, savedTask);</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>像 dva 这样的封装了 React/Redux-saga 的框架提供了一个捕获 effects 中错误的 onError hook，但使用一些其他框架时往往还是需要使用 try catch，老实说大量的重复编写这样的代码会感觉非常糟心。</p><h2 id=go-like-pattern>Go-like pattern</h2><p>在 Golang 中是没有 try catch 的，因为它通过返回多个值来解决这一问题，典型的 Go 代码是这样的：</p><pre><code class=language-go><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #24292E">data, err </span><span style="color: #D73A49">:=</span><span style="color: #24292E"> db.</span><span style="color: #005CC5">Query</span><span style="color: #24292E">(</span><span style="color: #032F62">&quot;SELECT ...&quot;</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #D73A49">if</span><span style="color: #24292E"> err </span><span style="color: #D73A49">!=</span><span style="color: #24292E"> </span><span style="color: #005CC5">nil</span><span style="color: #24292E"> { </span><span style="color: #D73A49">return</span><span style="color: #24292E"> err }</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #C9D1D9">data, err </span><span style="color: #FF7B72">:=</span><span style="color: #C9D1D9"> db.</span><span style="color: #79C0FF">Query</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&quot;SELECT ...&quot;</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> err </span><span style="color: #FF7B72">!=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nil</span><span style="color: #C9D1D9"> { </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> err }</span></span></code></pre></div>
</code></pre><p>随着 ES6 中解构赋值这一特性的引入，很快就有想到了像 Go 这样返回一个 error 和 resolve 值组成的数组这样有趣的方案：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">const</span><span style="color: #24292E"> [</span><span style="color: #005CC5">err</span><span style="color: #24292E">, </span><span style="color: #005CC5">data</span><span style="color: #24292E">] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">someTask</span><span style="color: #24292E">();</span></span>
<span class=line><span style="color: #D73A49">if</span><span style="color: #24292E"> (err) </span><span style="color: #D73A49">return</span><span style="color: #24292E">;</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">err</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">data</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">someTask</span><span style="color: #C9D1D9">();</span></span>
<span class=line><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (err) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9">;</span></span></code></pre></div>
</code></pre><p>由于 await 出错时如果没有 try catch 的话会静默的退出当前函数执行，因此我们需要一个简单的转换工具函数：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #6A737D">// to.js</span></span>
<span class=line><span style="color: #D73A49">export</span><span style="color: #E36209"> </span><span style="color: #D73A49">default</span><span style="color: #E36209"> </span><span style="color: #D73A49">function</span><span style="color: #E36209"> </span><span style="color: #6F42C1">to</span><span style="color: #E36209">(promise) </span><span style="color: #24292E">{</span></span>
<span class=line><span style="color: #24292E">   </span><span style="color: #D73A49">return</span><span style="color: #24292E"> promise.</span><span style="color: #6F42C1">then</span><span style="color: #24292E">(</span><span style="color: #E36209">data</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> [</span><span style="color: #005CC5">null</span><span style="color: #24292E">, data])</span></span>
<span class=line><span style="color: #24292E">   .</span><span style="color: #6F42C1">catch</span><span style="color: #24292E">(</span><span style="color: #E36209">err</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> [err, </span><span style="color: #005CC5">null</span><span style="color: #24292E">]);</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #8B949E">// to.js</span></span>
<span class=line><span style="color: #FF7B72">export</span><span style="color: #FFA657"> </span><span style="color: #FF7B72">default</span><span style="color: #FFA657"> </span><span style="color: #FF7B72">function</span><span style="color: #FFA657"> </span><span style="color: #D2A8FF">to</span><span style="color: #FFA657">(promise) </span><span style="color: #C9D1D9">{</span></span>
<span class=line><span style="color: #C9D1D9">   </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> promise.</span><span style="color: #D2A8FF">then</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">data</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">, data])</span></span>
<span class=line><span style="color: #C9D1D9">   .</span><span style="color: #D2A8FF">catch</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">err</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=&gt;</span><span style="color: #C9D1D9"> [err, </span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">]);</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>接下来就可以愉快的改写前面的代码了：</p><pre><code class=language-js><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">import</span><span style="color: #24292E"> to </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">&#39;./to.js&#39;</span><span style="color: #24292E">;</span></span>
<span class=line></span>
<span class=line><span style="color: #D73A49">async</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E"> </span><span style="color: #6F42C1">asyncTask</span><span style="color: #24292E">(</span><span style="color: #E36209">cb</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">let</span><span style="color: #24292E"> err, user, savedTask;</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    [err, user] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">to</span><span style="color: #24292E">(UserModel.</span><span style="color: #6F42C1">findById</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">));</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E">(</span><span style="color: #D73A49">!</span><span style="color: #24292E">user) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;No user found&#39;</span><span style="color: #24292E">);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    [err, savedTask] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">to</span><span style="color: #24292E">(</span><span style="color: #6F42C1">TaskModel</span><span style="color: #24292E">({userId: user.id, name: </span><span style="color: #032F62">&#39;Demo Task&#39;</span><span style="color: #24292E">}));</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E">(err) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;Error occurred while saving task&#39;</span><span style="color: #24292E">);</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E">(user.notificationsEnabled) {</span></span>
<span class=line><span style="color: #24292E">       </span><span style="color: #D73A49">const</span><span style="color: #24292E"> [</span><span style="color: #005CC5">err</span><span style="color: #24292E">] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">to</span><span style="color: #24292E">(NotificationService.</span><span style="color: #6F42C1">sendNotification</span><span style="color: #24292E">(user.id, </span><span style="color: #032F62">&#39;Task Created&#39;</span><span style="color: #24292E">));</span></span>
<span class=line><span style="color: #24292E">       </span><span style="color: #D73A49">if</span><span style="color: #24292E">(err) </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;Error while sending notification&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #6F42C1">cb</span><span style="color: #24292E">(</span><span style="color: #005CC5">null</span><span style="color: #24292E">, savedTask);</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> to </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">&#39;./to.js&#39;</span><span style="color: #C9D1D9">;</span></span>
<span class=line></span>
<span class=line><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">asyncTask</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">cb</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> err, user, savedTask;</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    [err, user] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">to</span><span style="color: #C9D1D9">(UserModel.</span><span style="color: #D2A8FF">findById</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">));</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">user) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;No user found&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    [err, savedTask] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">to</span><span style="color: #C9D1D9">(</span><span style="color: #D2A8FF">TaskModel</span><span style="color: #C9D1D9">({userId: user.id, name: </span><span style="color: #A5D6FF">&#39;Demo Task&#39;</span><span style="color: #C9D1D9">}));</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(err) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;Error occurred while saving task&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(user.notificationsEnabled) {</span></span>
<span class=line><span style="color: #C9D1D9">       </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">err</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">to</span><span style="color: #C9D1D9">(NotificationService.</span><span style="color: #D2A8FF">sendNotification</span><span style="color: #C9D1D9">(user.id, </span><span style="color: #A5D6FF">&#39;Task Created&#39;</span><span style="color: #C9D1D9">));</span></span>
<span class=line><span style="color: #C9D1D9">       </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9">(err) </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;Error while sending notification&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">cb</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">null</span><span style="color: #C9D1D9">, savedTask);</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>最后的代码看上去舒服多了有没有！当然上面这样的只是一个简单的工具函数，生产环境使用的话可能需要做更多的处理。</p><p>虽然平时的工作中还不能使用，但这样的 Go 风格代码我个人非常喜欢，感觉非常有意思。</p><h2 id=ref：>Ref：</h2><ul><li><p><a href=https://github.com/coleturner/promise.flatten>https://github.com/coleturner/promise.flatten#readme</a></p></li><li><p><a href=https://github.com/scopsy/await-to-js#readme>https://github.com/scopsy/await-to-js#readme</a></p></li></ul></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2021 zoubingwu. All rights reserved.</div></div></body></html>
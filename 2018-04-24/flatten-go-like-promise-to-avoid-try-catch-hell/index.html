<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=/assets/fonts/googlefont.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/assets/fonts/googlefont.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>Flatten Go-like promise to avoid try catch hell | https://zoubingwu.com</title><meta property=og:title content="Flatten Go-like promise to avoid try catch hell | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content="A interesting Go-like pattern to avoid try/catch hell in async/await."><meta property=og:description content="A interesting Go-like pattern to avoid try/catch hell in async/await."><link rel=canonical href=https://zoubingwu.com/2018-04-24/flatten-go-like-promise-to-avoid-try-catch-hell><meta property=og:url content=https://zoubingwu.com/2018-04-24/flatten-go-like-promise-to-avoid-try-catch-hell><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2018-04-24T14:29:31.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="Flatten Go-like promise to avoid try catch hell | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script></head><body><div class=content-container><div class=post><div class=post-title>Flatten Go-like promise to avoid try catch hell</div><span class=post-date><time>24 Apr 2018</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>javascript</span></a></li><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>promise</span></a></li></ul></div><h2 id=intro>Intro</h2><p>异步代码从最早的 callback hell，到现在的 ES7 我们已经可以用 async/await 来像编写同步代码一样优雅的编写了。</p><p>什么是回调地狱（callback hell）呢，看下面的代码就一目了然了：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">AsyncTask</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">   </span><span style="color: #61AFEF">asyncFuncA</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">resultA</span><span style="color: #ABB2BF">){</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #61AFEF">asyncFuncB</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">resultB</span><span style="color: #ABB2BF">){</span></span>
<span class=line><span style="color: #ABB2BF">         </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">          </span><span style="color: #61AFEF">asyncFuncC</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">resultC</span><span style="color: #ABB2BF">){</span></span>
<span class=line><span style="color: #ABB2BF">               </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">               </span><span style="color: #7F848E; font-style: italic">// And so it goes....</span></span>
<span class=line><span style="color: #ABB2BF">          });</span></span>
<span class=line><span style="color: #ABB2BF">      });</span></span>
<span class=line><span style="color: #ABB2BF">   });</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>这样的代码可读性和维护性都非常差，后来社区又引入了 promise：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncTask</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">cb</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">   </span><span style="color: #E5C07B">asyncFuncA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">AsyncFuncB</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">AsyncFuncC</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">AsyncFuncD</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      .</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">));</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>这样看上去确实是干净多了，但实际的开发中写多了会发现非常复杂的异步情况时，大量的 then 写起来还是有点累赘，而且很多时候的流程控制并非像这样线性的考虑，可能会出现很多分支。</p><p>ES7 终于推出了 async/await 标准，虽然浏览器并不直接支持，但我们使用 babel transpiler 或者 typescript 都可以享受这一特性。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">async</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncTask</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">cb</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UserModel</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">findById</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">!</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;No user found&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">savedTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">TaskModel</span><span style="color: #ABB2BF">({</span><span style="color: #E06C75">userId</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;Demo Task&#39;</span><span style="color: #ABB2BF">});</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">notificationsEnabled</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">NotificationService</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">sendNotification</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;Task Created&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">savedTask</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">assignedUser</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!==</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">NotificationService</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">sendNotification</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">savedTask</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">assignedUser</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;Task was created for you&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">savedTask</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>同样的还有基于 Generator 的解决方案：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #56B6C2">*</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncTask</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">task1</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">task2</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">task3</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">yield</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">task4</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>可以看到我们编写异步代码简直和同步代码几乎没有什么区别。代码看上去也干净利落，但有一个问题是，如果需要处理异步调用中的错误情况的话，只能使用 try catch，导致生产中我们的代码可能变成这样：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">async</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncTask</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">cb</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">       </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UserModel</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">findById</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">       </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">!</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;No user found&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Unexpected error occurred&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">       </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">savedTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">TaskModel</span><span style="color: #ABB2BF">({</span><span style="color: #E06C75">userId</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;Demo Task&#39;</span><span style="color: #ABB2BF">});</span></span>
<span class=line><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Error occurred while saving task&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">notificationsEnabled</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">            </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">NotificationService</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">sendNotification</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;Task Created&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">        } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Error while sending notification&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">        }</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">savedTask</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">assignedUser</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!==</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">            </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">NotificationService</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">sendNotification</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">savedTask</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">assignedUser</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;Task was created for you&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">        } </span><span style="color: #C678DD">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Error while sending notification&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">        }</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">savedTask</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>像 dva 这样的封装了 React/Redux-saga 的框架提供了一个捕获 effects 中错误的 onError hook，但使用一些其他框架时往往还是需要使用 try catch，老实说大量的重复编写这样的代码会感觉非常糟心。</p><h2 id=go-like-pattern>Go-like pattern</h2><p>在 Golang 中是没有 try catch 的，因为它通过返回多个值来解决这一问题，典型的 Go 代码是这样的：</p><pre><code class=language-go><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E06C75">data</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">err</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">:=</span><span style="color: #ABB2BF"> db.</span><span style="color: #56B6C2">Query</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;SELECT ...&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> err </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">nil</span><span style="color: #ABB2BF"> { </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> err }</span></span></code></pre>
</code></pre><p>随着 ES6 中解构赋值这一特性的引入，很快就有想到了像 Go 这样返回一个 error 和 resolve 值组成的数组这样有趣的方案：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> [</span><span style="color: #E5C07B">err</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">data</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">someTask</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">;</span></span></code></pre>
</code></pre><p>由于 await 出错时如果没有 try catch 的话会静默的退出当前函数执行，因此我们需要一个简单的转换工具函数：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// to.js</span></span>
<span class=line><span style="color: #C678DD">export</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">default</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">to</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">promise</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">   </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> [</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">])</span></span>
<span class=line><span style="color: #ABB2BF">   .</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> [</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">]);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>接下来就可以愉快的改写前面的代码了：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">to</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;./to.js&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">async</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">asyncTask</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">cb</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">let</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">savedTask</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    [</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">to</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UserModel</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">findById</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">));</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">!</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;No user found&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    [</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">savedTask</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">to</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">TaskModel</span><span style="color: #ABB2BF">({</span><span style="color: #E06C75">userId</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;Demo Task&#39;</span><span style="color: #ABB2BF">}));</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Error occurred while saving task&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">notificationsEnabled</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">       </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> [</span><span style="color: #E5C07B">err</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">to</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">NotificationService</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">sendNotification</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;Task Created&#39;</span><span style="color: #ABB2BF">));</span></span>
<span class=line><span style="color: #ABB2BF">       </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Error while sending notification&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">cb</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">savedTask</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>最后的代码看上去舒服多了有没有！当然上面这样的只是一个简单的工具函数，生产环境使用的话可能需要做更多的处理。</p><p>虽然平时的工作中还不能使用，但这样的 Go 风格代码我个人非常喜欢，感觉非常有意思。</p><h2 id=ref：>Ref：</h2><ul><li><p><a href=https://github.com/coleturner/promise.flatten>https://github.com/coleturner/promise.flatten#readme</a></p></li><li><p><a href=https://github.com/scopsy/await-to-js#readme>https://github.com/scopsy/await-to-js#readme</a></p></li></ul></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2021 zoubingwu. All rights reserved.</div></div></body></html>
<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=/assets/fonts/googlefont.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/assets/fonts/googlefont.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>设计模式实践之发布-订阅模式 | https://zoubingwu.com</title><meta property=og:title content="设计模式实践之发布-订阅模式 | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content=发布-订阅模式又叫观察者模式，在平时的javascript程序编写里其实这种模式是非常常见的，比如我们曾经给DOM节点绑定过事件，就是典型的发布-订阅模式...><meta property=og:description content=发布-订阅模式又叫观察者模式，在平时的javascript程序编写里其实这种模式是非常常见的，比如我们曾经给DOM节点绑定过事件，就是典型的发布-订阅模式...><link rel=canonical href=https://zoubingwu.com/2017-05-14/设计模式实践之发布-订阅模式><meta property=og:url content=https://zoubingwu.com/2017-05-14/设计模式实践之发布-订阅模式><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2017-05-14T19:38:27.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="设计模式实践之发布-订阅模式 | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script></head><body><div class=content-container><div class=post><div class=post-title>设计模式实践之发布-订阅模式</div><span class=post-date><time>14 May 2017</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>patterns</span></a></li></ul></div><p>发布-订阅模式又叫观察者模式，在平时的javascript程序编写里其实这种模式是非常常见的，比如我们曾经给DOM节点绑定过事件，就是典型的发布-订阅模式：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #24292E">document.body.</span><span style="color: #6F42C1">addEventListener</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;click&#39;</span><span style="color: #24292E">, </span><span style="color: #D73A49">function</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">alert</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;clicked!&#39;</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">}, </span><span style="color: #005CC5">false</span><span style="color: #24292E">)</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">document.body.</span><span style="color: #6F42C1">click</span><span style="color: #24292E">()</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #C9D1D9">document.body.</span><span style="color: #D2A8FF">addEventListener</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;click&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">alert</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;clicked!&#39;</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">}, </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">)</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">document.body.</span><span style="color: #D2A8FF">click</span><span style="color: #C9D1D9">()</span></span></code></pre></div>
</code></pre><p>这种模式广泛的应用于异步编程中，事件监听就是一种简单的实现。如果我们把事件理解为一种信号，某个任务完成后就向信号中心发布一个信号，其他任务订阅这个信号，就可以知道自己什么时候开始执行，来看一个简单的例子：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> center </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {}; </span><span style="color: #6A737D">// 定义信号中心</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">center.subscribeList </span><span style="color: #D73A49">=</span><span style="color: #24292E"> []; </span><span style="color: #6A737D">// 缓存列表</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">subscribe</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">fn</span><span style="color: #24292E">) { </span><span style="color: #6A737D">// 增加订阅</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList.</span><span style="color: #6F42C1">push</span><span style="color: #24292E">(fn); </span><span style="color: #6A737D">// 订阅的消息放入缓存列表</span></span>
<span class=line><span style="color: #24292E">};</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">() { </span><span style="color: #6A737D">// 发布消息</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">var</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">, fn; fn </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[i</span><span style="color: #D73A49">++</span><span style="color: #24292E">];) {</span></span>
<span class=line><span style="color: #24292E">    fn.</span><span style="color: #6F42C1">apply</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">, </span><span style="color: #005CC5">arguments</span><span style="color: #24292E">);  </span><span style="color: #6A737D">// 发布时带上参数</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// 下面进行测试，先订阅消息</span></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">subscribe</span><span style="color: #24292E">(</span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">signal</span><span style="color: #24292E">, </span><span style="color: #E36209">action</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;触发信号：&#39;</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> signal);</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;执行动作：&#39;</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> action);</span></span>
<span class=line><span style="color: #24292E">});</span></span>
<span class=line></span>
<span class=line><span style="color: #6A737D">// 发布时输出：</span></span>
<span class=line><span style="color: #6A737D">// 触发信号：click</span></span>
<span class=line><span style="color: #6A737D">// 执行动作：write something</span></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;click&#39;</span><span style="color: #24292E">, </span><span style="color: #032F62">&#39;write something&#39;</span><span style="color: #24292E">);</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> center </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {}; </span><span style="color: #8B949E">// 定义信号中心</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">center.subscribeList </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> []; </span><span style="color: #8B949E">// 缓存列表</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">subscribe</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">fn</span><span style="color: #C9D1D9">) { </span><span style="color: #8B949E">// 增加订阅</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList.</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(fn); </span><span style="color: #8B949E">// 订阅的消息放入缓存列表</span></span>
<span class=line><span style="color: #C9D1D9">};</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">publish</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">() { </span><span style="color: #8B949E">// 发布消息</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, fn; fn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">];) {</span></span>
<span class=line><span style="color: #C9D1D9">    fn.</span><span style="color: #D2A8FF">apply</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">arguments</span><span style="color: #C9D1D9">);  </span><span style="color: #8B949E">// 发布时带上参数</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// 下面进行测试，先订阅消息</span></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">subscribe</span><span style="color: #C9D1D9">(</span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">signal</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">action</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;触发信号：&#39;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> signal);</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;执行动作：&#39;</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">+</span><span style="color: #C9D1D9"> action);</span></span>
<span class=line><span style="color: #C9D1D9">});</span></span>
<span class=line></span>
<span class=line><span style="color: #8B949E">// 发布时输出：</span></span>
<span class=line><span style="color: #8B949E">// 触发信号：click</span></span>
<span class=line><span style="color: #8B949E">// 执行动作：write something</span></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">publish</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;click&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #A5D6FF">&#39;write something&#39;</span><span style="color: #C9D1D9">);</span></span></code></pre></div>
</code></pre><p>上面就是一个最简单的发布-订阅模式，但是我们可以发现，发布的时候实际上所有人都会收到这条发布的消息，因此我们需要增加一个标示，来让订阅者只订阅自己感兴趣的消息：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> center </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {}; </span><span style="color: #6A737D">// 定义中心</span></span>
<span class=line><span style="color: #24292E">center.subscribeList </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {};  </span><span style="color: #6A737D">// 缓存列表</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">subscribe</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">signal</span><span style="color: #24292E">, </span><span style="color: #E36209">fn</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal]) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [];  </span><span style="color: #6A737D">// 如果没有存放过此类消息才创建一个针对此类消息的缓存列表</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal].</span><span style="color: #6F42C1">push</span><span style="color: #24292E">(fn);</span></span>
<span class=line><span style="color: #24292E">};</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">var</span><span style="color: #24292E"> signal </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">Array</span><span style="color: #24292E">.</span><span style="color: #005CC5">prototype</span><span style="color: #24292E">.shift.</span><span style="color: #6F42C1">call</span><span style="color: #24292E">(</span><span style="color: #005CC5">arguments</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">var</span><span style="color: #24292E"> fns </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal];</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">fns </span><span style="color: #D73A49">||</span><span style="color: #24292E"> fns.</span><span style="color: #005CC5">length</span><span style="color: #24292E"> </span><span style="color: #D73A49">===</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">var</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">, fn; fn </span><span style="color: #D73A49">=</span><span style="color: #24292E"> fns[i</span><span style="color: #D73A49">++</span><span style="color: #24292E">];) {</span></span>
<span class=line><span style="color: #24292E">    fn.</span><span style="color: #6F42C1">apply</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">, </span><span style="color: #005CC5">arguments</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">subscribe</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;click&#39;</span><span style="color: #24292E">, </span><span style="color: #D73A49">function</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;ok someone just clicked something...&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">});</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">subscribe</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;scroll&#39;</span><span style="color: #24292E">, </span><span style="color: #D73A49">function</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;lol stop scrolling, dude!&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">})</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;click&#39;</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(</span><span style="color: #032F62">&#39;scroll&#39;</span><span style="color: #24292E">);</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> center </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {}; </span><span style="color: #8B949E">// 定义中心</span></span>
<span class=line><span style="color: #C9D1D9">center.subscribeList </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {};  </span><span style="color: #8B949E">// 缓存列表</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">subscribe</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">signal</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">fn</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal]) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];  </span><span style="color: #8B949E">// 如果没有存放过此类消息才创建一个针对此类消息的缓存列表</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal].</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(fn);</span></span>
<span class=line><span style="color: #C9D1D9">};</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">publish</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> signal </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Array</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">prototype</span><span style="color: #C9D1D9">.shift.</span><span style="color: #D2A8FF">call</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">arguments</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> fns </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal];</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">fns </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> fns.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, fn; fn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> fns[i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">];) {</span></span>
<span class=line><span style="color: #C9D1D9">    fn.</span><span style="color: #D2A8FF">apply</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">arguments</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">subscribe</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;click&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;ok someone just clicked something...&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">});</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">subscribe</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;scroll&#39;</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">  console.</span><span style="color: #D2A8FF">log</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;lol stop scrolling, dude!&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">})</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">publish</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;click&#39;</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">publish</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">&#39;scroll&#39;</span><span style="color: #C9D1D9">);</span></span></code></pre></div>
</code></pre><p>我们把发布中心的订阅列表换成了一个对象，现在它的结构是这样的：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #24292E">{</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #032F62">&#39;click&#39;</span><span style="color: #24292E">: [a, b, c, </span><span style="color: #D73A49">...</span><span style="color: #24292E">],</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #032F62">&#39;scroll&#39;</span><span style="color: #24292E">: [d, e, f, </span><span style="color: #D73A49">...</span><span style="color: #24292E">],</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">...</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">...</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #C9D1D9">{</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;click&#39;</span><span style="color: #C9D1D9">: [a, b, c, </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9">],</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #A5D6FF">&#39;scroll&#39;</span><span style="color: #C9D1D9">: [d, e, f, </span><span style="color: #FF7B72">...</span><span style="color: #C9D1D9">],</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">...</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">...</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>如此，就可以订阅只针对这一类的消息了。</p><p>现在我们再加入取消订阅事件的方法：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #24292E">center.</span><span style="color: #6F42C1">unsub</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">signal</span><span style="color: #24292E">, </span><span style="color: #E36209">fn</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">var</span><span style="color: #24292E"> fns </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal];</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">fns) { </span><span style="color: #6A737D">// 如果这一类信号没有被人订阅，直接返回</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">fn) {  </span><span style="color: #6A737D">// 如果没有传入需要取消的具体回调函数，意味着需要移除所有的对应的回调</span></span>
<span class=line><span style="color: #24292E">    fns </span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> (fns.</span><span style="color: #005CC5">length</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">  } </span><span style="color: #D73A49">else</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">var</span><span style="color: #24292E"> l </span><span style="color: #D73A49">=</span><span style="color: #24292E"> fns.</span><span style="color: #005CC5">length</span><span style="color: #24292E"> </span><span style="color: #D73A49">-</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">; l </span><span style="color: #D73A49">&gt;=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; l</span><span style="color: #D73A49">--</span><span style="color: #24292E">) { </span><span style="color: #6A737D">// 反向遍历订阅的回调函数列表</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">var</span><span style="color: #24292E"> _fn </span><span style="color: #D73A49">=</span><span style="color: #24292E"> fns[l];</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (_fn </span><span style="color: #D73A49">===</span><span style="color: #24292E"> fn) {</span></span>
<span class=line><span style="color: #24292E">        fns.</span><span style="color: #6F42C1">splice</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">); </span><span style="color: #6A737D">// 删除回调函数</span></span>
<span class=line><span style="color: #24292E">      }</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #C9D1D9">center.</span><span style="color: #D2A8FF">unsub</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">signal</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">fn</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> fns </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal];</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">fns) { </span><span style="color: #8B949E">// 如果这一类信号没有被人订阅，直接返回</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">fn) {  </span><span style="color: #8B949E">// 如果没有传入需要取消的具体回调函数，意味着需要移除所有的对应的回调</span></span>
<span class=line><span style="color: #C9D1D9">    fns </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> (fns.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">  } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> l </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> fns.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">; l </span><span style="color: #FF7B72">&gt;=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; l</span><span style="color: #FF7B72">--</span><span style="color: #C9D1D9">) { </span><span style="color: #8B949E">// 反向遍历订阅的回调函数列表</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> _fn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> fns[l];</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (_fn </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> fn) {</span></span>
<span class=line><span style="color: #C9D1D9">        fns.</span><span style="color: #D2A8FF">splice</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">); </span><span style="color: #8B949E">// 删除回调函数</span></span>
<span class=line><span style="color: #C9D1D9">      }</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>具体效果如下图：</p><p><img src=https://res.cloudinary.com/dxmlgmzb7/image/upload/v1494767085/blog/subpub_iyksth.gif alt=https://res.cloudinary.com/dxmlgmzb7/image/upload/v1494767085/blog/subpub_iyksth.gif></p><p>最后我们把这一段代码封装，并添加一个安装的函数，这样就可以给所有的对象动态安装发布-订阅的功能：</p><pre><code class=language-javascript><div class=shiki-light><pre class=shiki style="background-color: #ffffff"><code><span class=line><span style="color: #D73A49">var</span><span style="color: #24292E"> event </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">  subscribeList: {},</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">subscribe</span><span style="color: #24292E">: </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">signal</span><span style="color: #24292E">, </span><span style="color: #E36209">fn</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal]) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> [];</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal].</span><span style="color: #6F42C1">push</span><span style="color: #24292E">(fn);</span></span>
<span class=line><span style="color: #24292E">  },</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">publish</span><span style="color: #24292E">: </span><span style="color: #D73A49">function</span><span style="color: #24292E">() {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">var</span><span style="color: #24292E"> signal </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">Array</span><span style="color: #24292E">.</span><span style="color: #005CC5">prototype</span><span style="color: #24292E">.shift.</span><span style="color: #6F42C1">call</span><span style="color: #24292E">(</span><span style="color: #005CC5">arguments</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">var</span><span style="color: #24292E"> fns </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal];</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">fns </span><span style="color: #D73A49">||</span><span style="color: #24292E"> fns.</span><span style="color: #005CC5">length</span><span style="color: #24292E"> </span><span style="color: #D73A49">===</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">    } </span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">var</span><span style="color: #24292E"> i </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">, fn; fn </span><span style="color: #D73A49">=</span><span style="color: #24292E"> fns[i</span><span style="color: #D73A49">++</span><span style="color: #24292E">];) {</span></span>
<span class=line><span style="color: #24292E">      fn.</span><span style="color: #6F42C1">apply</span><span style="color: #24292E">(</span><span style="color: #005CC5">this</span><span style="color: #24292E">, </span><span style="color: #005CC5">arguments</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line><span style="color: #24292E">  },</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">unsub</span><span style="color: #24292E">: </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">signal</span><span style="color: #24292E">, </span><span style="color: #E36209">fn</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">var</span><span style="color: #24292E"> fns </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">.subscribeList[signal];</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">fns) {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> </span><span style="color: #005CC5">false</span><span style="color: #24292E">;</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (</span><span style="color: #D73A49">!</span><span style="color: #24292E">fn) {</span></span>
<span class=line><span style="color: #24292E">      fns </span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> (fns.</span><span style="color: #005CC5">length</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">)</span></span>
<span class=line><span style="color: #24292E">    } </span><span style="color: #D73A49">else</span><span style="color: #24292E"> {</span></span>
<span class=line><span style="color: #24292E">      </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">var</span><span style="color: #24292E"> l </span><span style="color: #D73A49">=</span><span style="color: #24292E"> fns.</span><span style="color: #005CC5">length</span><span style="color: #24292E"> </span><span style="color: #D73A49">-</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E">; l </span><span style="color: #D73A49">&gt;=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">; l</span><span style="color: #D73A49">--</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">var</span><span style="color: #24292E"> _fn </span><span style="color: #D73A49">=</span><span style="color: #24292E"> fns[l];</span></span>
<span class=line><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (_fn </span><span style="color: #D73A49">===</span><span style="color: #24292E"> fn) {</span></span>
<span class=line><span style="color: #24292E">          fns.</span><span style="color: #6F42C1">splice</span><span style="color: #24292E">(</span><span style="color: #005CC5">1</span><span style="color: #24292E">, </span><span style="color: #005CC5">1</span><span style="color: #24292E">);</span></span>
<span class=line><span style="color: #24292E">        }</span></span>
<span class=line><span style="color: #24292E">      }</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line><span style="color: #24292E">  },</span></span>
<span class=line></span>
<span class=line><span style="color: #24292E">  </span><span style="color: #6F42C1">installEvent</span><span style="color: #24292E">: </span><span style="color: #D73A49">function</span><span style="color: #24292E">(</span><span style="color: #E36209">obj</span><span style="color: #24292E">) {</span></span>
<span class=line><span style="color: #24292E">    </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">var</span><span style="color: #24292E"> i </span><span style="color: #D73A49">in</span><span style="color: #24292E"> event) {</span></span>
<span class=line><span style="color: #24292E">      obj[i] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> event[i];</span></span>
<span class=line><span style="color: #24292E">    }</span></span>
<span class=line><span style="color: #24292E">  }</span></span>
<span class=line><span style="color: #24292E">}</span></span></code></pre></div><div class=shiki-dark><pre class=shiki style="background-color: #0d1117"><code><span class=line><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> event </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">  subscribeList: {},</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">subscribe</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">signal</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">fn</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal]) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> [];</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal].</span><span style="color: #D2A8FF">push</span><span style="color: #C9D1D9">(fn);</span></span>
<span class=line><span style="color: #C9D1D9">  },</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">publish</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">() {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> signal </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">Array</span><span style="color: #C9D1D9">.</span><span style="color: #79C0FF">prototype</span><span style="color: #C9D1D9">.shift.</span><span style="color: #D2A8FF">call</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">arguments</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> fns </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal];</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">fns </span><span style="color: #FF7B72">||</span><span style="color: #C9D1D9"> fns.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">    } </span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">, fn; fn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> fns[i</span><span style="color: #FF7B72">++</span><span style="color: #C9D1D9">];) {</span></span>
<span class=line><span style="color: #C9D1D9">      fn.</span><span style="color: #D2A8FF">apply</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">arguments</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line><span style="color: #C9D1D9">  },</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">unsub</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">signal</span><span style="color: #C9D1D9">, </span><span style="color: #FFA657">fn</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> fns </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">this</span><span style="color: #C9D1D9">.subscribeList[signal];</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">fns) {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">;</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">!</span><span style="color: #C9D1D9">fn) {</span></span>
<span class=line><span style="color: #C9D1D9">      fns </span><span style="color: #FF7B72">&amp;&amp;</span><span style="color: #C9D1D9"> (fns.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">)</span></span>
<span class=line><span style="color: #C9D1D9">    } </span><span style="color: #FF7B72">else</span><span style="color: #C9D1D9"> {</span></span>
<span class=line><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> l </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> fns.</span><span style="color: #79C0FF">length</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">-</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">; l </span><span style="color: #FF7B72">&gt;=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">; l</span><span style="color: #FF7B72">--</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> _fn </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> fns[l];</span></span>
<span class=line><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">if</span><span style="color: #C9D1D9"> (_fn </span><span style="color: #FF7B72">===</span><span style="color: #C9D1D9"> fn) {</span></span>
<span class=line><span style="color: #C9D1D9">          fns.</span><span style="color: #D2A8FF">splice</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class=line><span style="color: #C9D1D9">        }</span></span>
<span class=line><span style="color: #C9D1D9">      }</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line><span style="color: #C9D1D9">  },</span></span>
<span class=line></span>
<span class=line><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">installEvent</span><span style="color: #C9D1D9">: </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9">(</span><span style="color: #FFA657">obj</span><span style="color: #C9D1D9">) {</span></span>
<span class=line><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">for</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">var</span><span style="color: #C9D1D9"> i </span><span style="color: #FF7B72">in</span><span style="color: #C9D1D9"> event) {</span></span>
<span class=line><span style="color: #C9D1D9">      obj[i] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> event[i];</span></span>
<span class=line><span style="color: #C9D1D9">    }</span></span>
<span class=line><span style="color: #C9D1D9">  }</span></span>
<span class=line><span style="color: #C9D1D9">}</span></span></code></pre></div>
</code></pre><p>现在似乎一切都很不错了，但是还有一个小小的瑕疵，我们给每一个对象都添加这么一个功能的时候会给每个对象都添加上各种方法和一个缓存的列表对象，这其实是一种资源浪费。另外如果需要订阅的信号位于其他的中心，那么我们就必须要订阅多个中心的信号，因此我们需要一个全局的Event对象就可以实现了，不需要了解信号来自哪一个中心，中心发布时也不需要了解推送给哪一个订阅者。</p><p>这种思路其实就是<code>Vue</code>的文档中提到的<code>Event Bus</code>，简单的模块间通信时，通过一个创建一个新的空<code>Vue</code>对象作为全局的<code>Event Bus</code>，实现这种订阅和发布模式。当然如果是特别复杂的情况，这种模式维护起来就很麻烦了。</p><p>最后，有心的人可能会注意到我们之前所有的例子，都需要先订阅一个信号，然后才能接受到发布的消息，如果反过来，那么发布出来的消息在没有人订阅的情况下，就消失了再也无法看到。</p><p>某些时候我们需要把这条消息先保存下来，等到有人来订阅的时候，再重新发布给订阅者。为了满足这个需求，我们需要建立一个存放这个消息的堆栈，如果发布时没有人订阅，就把这个发布的动作包装在一个函数中放入这个堆栈中，等到有人来订阅的时候，可以遍历堆栈并依次执行这些包装函数，具体的代码大家可以自己去实现以下，我就不放在这里了。</p></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2021 zoubingwu. All rights reserved.</div></div></body></html>
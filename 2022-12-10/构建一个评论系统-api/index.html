<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>构建一个评论系统 API | https://zoubingwu.com</title><meta property=og:title content="构建一个评论系统 API | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content="利用 Cloudflare Worker 和 D1 快速构建自己的评论系统接口。"><meta property=og:description content="利用 Cloudflare Worker 和 D1 快速构建自己的评论系统接口。"><link rel=canonical href=https://zoubingwu.com/2022-12-10/构建一个评论系统-api><meta property=og:url content=https://zoubingwu.com/2022-12-10/构建一个评论系统-api><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2022-12-10T22:34:33.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="构建一个评论系统 API | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script><script defer=defer data-domain=zoubingwu.com src=https://plausible.io/js/script.js></script></head><body><div class=content-container><div class=post><div class=post-title>构建一个评论系统 API</div><span class=post-date><time>10 Dec 2022</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>js</span></a></li><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>serverless</span></a></li><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>cloudflare</span></a></li></ul></div><h2 id=前言>前言</h2><p>评论系统是一个比较常见的模块，各种博客等网站经常会有让用户阅读后留言交流的需求，比较常见的有老牌的 <a href=https://disqus.com/ >Disqus</a>，或者基于 GitHub Issue 实现的一些方案，例如 <a href=https://github.com/utterance/utterances>utterances</a> 和 <a href=https://github.com/imsun/gitment>gitment</a>，它们在使用时需要用户拥有 GitHub 账户，还有更轻量，对隐私友好的 <a href=https://github.com/djyde/cusdis>Cusdis</a>。当然他们都有各自的优缺点，如果你有一定的开发能力，更喜欢自己动手，自己掌控所有的数据，并可以进行随心所欲的定制，又懒得去长期维护一台服务器，可以尝试利用 Cloudflare Worker 和 D1 来快速构建一个自己的评论系统。</p><p><a href=https://developers.cloudflare.com/workers/ >Cloudflare Worker</a> 是一个 Serverless 环境，让你完全不用操心各种基础设施的问题，只用专注于实现接口逻辑，部署只需要一行命令上传代码，而且免费额度提供了每日十万的请求数量，这对一些小流量的站点来说完全够用了。同样类型的产品还有很多，像 AWS Lambda，Deno deploy 等，但这次我们选择 Cloudflare Worker，因为正好它提供了一个内置的关系型数据库产品叫 <a href=https://developers.cloudflare.com/d1/ >D1</a>，目前处于 Open Alpha 阶段，它是基于 SQLite 构建的。SQLite 是世界上使用最普遍的数据库，每天被数十亿台设备使用，而且还是一个不需要服务器的数据库，你现在可以在 Worker 里直接使用它，但和跑在服务器或者某个设备上的一个进程中使用的区别是，你的 Worker 跑在全球数百个边缘计算节点上！</p><h2 id=准备环境>准备环境</h2><p>使用 Cloudflare Worker 需要懂一些简单的 JavaScript，这里会需要准备好 Node.js 环境，Cloudflare 提供了一个很方便的命令行工具叫 <code>wrangler</code> 可以通过 npm 来安装。</p><p>创建一个项目文件夹并且安装依赖：</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">mkdir my-project &amp;&amp; </span><span style="color: #56B6C2">cd</span><span style="color: #ABB2BF"> my-project</span></span>
<span class=line><span style="color: #ABB2BF">npm init -y</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">pnpm add wrangler -D</span></span></code></pre>
</code></pre><p>然后利用 wrangler 来帮助我们生成一个 Cloudflare Worker 项目需要的相关文件，如果选择使用 TypeScript 它也会帮你生成相关配置和安装依赖，并且我们让它帮我们在入口 <code>src/index.ts</code> 生成 <code>Fetch handler</code> 代码：</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">npx wrangler init</span></span></code></pre>
</code></pre><p>其中 <code>wrangler.toml</code> 文件是 wrangler 的一些配置，之后的 D1 的配置也需要写到里面去，而 <code>src/index.ts</code> 是入口文件，它会导出一个 fetch 函数，这个函数就是收到请求的入口函数。</p><pre><code class=language-ts><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">export</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">default</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">async</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">fetch</span><span style="color: #ABB2BF">(</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">request</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Request</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">env</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Env</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E06C75; font-style: italic">ctx</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">ExecutionContext</span></span>
<span class=line><span style="color: #ABB2BF">    ): </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">&lt;</span><span style="color: #E5C07B">Response</span><span style="color: #ABB2BF">&gt; {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Response</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Hello World!&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    },</span></span>
<span class=line><span style="color: #ABB2BF">};</span></span></code></pre>
</code></pre><p>之后我们会在这个请求里加入路由的逻辑，让它处理评论系统的一些增删改查操作。</p><h2 id=数据库设计>数据库设计</h2><p>首先我们需要通过 wrangler 登录 Cloudflare，直接使用 <code>npx wrangler login</code> 命令然后在网页中操作就可以了，然后就可以创建一个数据库：</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">npx wrangler d1 create &lt;DATABASE_NAME&gt;</span></span></code></pre>
</code></pre><p>成功后可以通过命令查看数据库的 id：</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">npx wrangler d1 list</span></span></code></pre>
</code></pre><p>记录一下它的 uuid 和 name，然后更新到 <code>wrangler.toml</code> 配置里：</p><pre><code class=language-toml><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">[[ </span><span style="color: #61AFEF">d1_databases</span><span style="color: #ABB2BF"> ]]</span></span>
<span class=line><span style="color: #E06C75">binding</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&quot;&lt;BINDING_NAME&gt;&quot;</span></span>
<span class=line><span style="color: #E06C75">database_name</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&quot;&lt;DATABASE_NAME&gt;&quot;</span></span>
<span class=line><span style="color: #E06C75">database_id</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&quot;&lt;UUID&gt;&quot;</span></span></code></pre>
</code></pre><p>这里的 BINDING_NAME 可以随便取一个，它是用来告诉 Worker 如何访问数据库资源的，你可以看到 <code>src/index.ts</code> 里声明了一个 Env，那么在 Worker 里就可以通过 <code>Env.&lt;BINDING_NAME&gt;</code> 来访问数据库了。这里假设这个 BINDING_NAME 就叫 DB 好了，确定了 BINDING_NAME 以后来更新一下这个 Env 类型，：</p><pre><code class=language-toml><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E06C75">binding</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&quot;DB&quot;</span></span></code></pre>
</code></pre><pre><code class=language-ts><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">export</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">interface</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Env</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">DB</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">D1Database</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>完成这些准备工作以后，就可以设计一下数据库的表，评论表最简单的实现就是下面这样了，创建一个 <code>schema.sql</code>：</p><pre><code class=language-sql><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">DROP</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">TABLE</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">IF</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">EXISTS</span><span style="color: #ABB2BF"> Comments;</span></span>
<span class=line><span style="color: #C678DD">CREATE</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">TABLE</span><span style="color: #ABB2BF"> Comments(</span></span>
<span class=line><span style="color: #ABB2BF">  id          </span><span style="color: #C678DD">TEXT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">NOT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">NULL</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">PRIMARY</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">KEY</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  createdAt   </span><span style="color: #C678DD">TEXT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">NOT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">NULL</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  content     </span><span style="color: #C678DD">TEXT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">NOT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">NULL</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  nickname    </span><span style="color: #C678DD">TEXT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">NOT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">NULL</span></span>
<span class=line><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>由于使用的是 SQLite，因此数据类型相比 MySQL 更简单一点，可以在 <code>schema.sql</code> 里再插入一些测试数据：</p><pre><code class=language-sql><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">INSERT</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">INTO</span><span style="color: #ABB2BF"> Comments(id,createdAt,content,nickname) </span><span style="color: #C678DD">VALUES</span><span style="color: #ABB2BF"> (</span><span style="color: #98C379">&#39;989c9329-e989-46a7-87ab-dee178aa417a&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;2022-12-10T12:37:40.106Z&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;first!&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;test&#39;</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>然后在本地跑一下试试：</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">npx wrangler d1 execute &lt;DATABASE_NAME&gt; --local --file=./schema.sql</span></span></code></pre>
</code></pre><p>记得带上 --local 这个 flag 让它在本地创建一个数据库执行，否则命令会直接在线上的数据库执行，然后检查一下结果：</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">npx wrangler d1 execute &lt;DATABASE_NAME&gt; --local --command=</span><span style="color: #98C379">&#39;SELECT * FROM Comments&#39;</span></span></code></pre>
</code></pre><p>顺利的话就能看到结果了。</p><h2 id=实现接口>实现接口</h2><p>接下来只需要短短几十行代码，就可以在 Worker 里实现一个创建评论和一个获取评论的接口：</p><p>在 <code>fetch</code> 函数里可以根据请求的 path 和 method 来实现路由，如果你希望代码更干净一点，可以使用 <strong><a href=https://github.com/kwhitley/itty-router>itty-router</a></strong> 这样为 Cloudflare Worker 设计的路由库。</p><pre><code class=language-ts><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">export</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">default</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">async</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">fetch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">request</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Request</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">env</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Env</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> { </span><span style="color: #E5C07B">pathname</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">searchParams</span><span style="color: #ABB2BF"> } </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">URL</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">request</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">);</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">request</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">method</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;GET&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pathname</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;/api/comments&#39;</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">page</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Number</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">searchParams</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;page&#39;</span><span style="color: #ABB2BF">)) </span><span style="color: #56B6C2">||</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pageSize</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Number</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">searchParams</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;pageSize&#39;</span><span style="color: #ABB2BF">)) </span><span style="color: #56B6C2">||</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getComments</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">env</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">page</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">pageSize</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">request</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">method</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;POST&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pathname</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;/api/comments&#39;</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">body</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">request</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">&lt;</span><span style="color: #E5C07B">PostCommentBody</span><span style="color: #ABB2BF">&gt;();</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> { </span><span style="color: #E5C07B">content</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">nickname</span><span style="color: #ABB2BF"> } </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">body</span><span style="color: #ABB2BF">;</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #7F848E; font-style: italic">// 一些简单的校验</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #56B6C2">!</span><span style="color: #E06C75">content</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">||</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #56B6C2">!</span><span style="color: #E06C75">nickname</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">||</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">content</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">length</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">255</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">||</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">nickname</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">length</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">100</span></span>
<span class=line><span style="color: #ABB2BF">      ) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Response</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, { </span><span style="color: #E06C75">status</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">400</span><span style="color: #ABB2BF"> });</span></span>
<span class=line><span style="color: #ABB2BF">      }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">postComment</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">env</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">body</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">content</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">body</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">nickname</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Response</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, { </span><span style="color: #E06C75">status</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">404</span><span style="color: #ABB2BF"> });;</span></span>
<span class=line><span style="color: #ABB2BF">  },</span></span>
<span class=line><span style="color: #ABB2BF">};</span></span></code></pre>
</code></pre><p>然后接下来实现 <code>getComments</code> 和 <code>postComment</code> 这两个函数，这里面可以直接访问数据库来获取数据并返回。</p><pre><code class=language-ts><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">interface</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Comment</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">string</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">content</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">string</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">createdAt</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">string</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">nickname</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">string</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getComments</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">async</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">env</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Env</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">page</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">number</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">pageSize</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">number</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> { </span><span style="color: #E5C07B">results</span><span style="color: #ABB2BF"> } </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">DB</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">prepare</span><span style="color: #ABB2BF">(</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #98C379">&#39;SELECT * FROM Comments ORDER BY rowid DESC LIMIT ? OFFSET ?&#39;</span></span>
<span class=line><span style="color: #ABB2BF">  )</span></span>
<span class=line><span style="color: #ABB2BF">    .</span><span style="color: #61AFEF">bind</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">pageSize</span><span style="color: #ABB2BF">, (</span><span style="color: #E06C75">page</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pageSize</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">    .</span><span style="color: #61AFEF">all</span><span style="color: #ABB2BF">&lt;</span><span style="color: #E5C07B">Comment</span><span style="color: #ABB2BF">&gt;();</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">res</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">DB</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">prepare</span><span style="color: #ABB2BF">(</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #98C379">`SELECT COUNT(*) as count FROM Comments`</span></span>
<span class=line><span style="color: #ABB2BF">  ).</span><span style="color: #61AFEF">first</span><span style="color: #ABB2BF">&lt;{ </span><span style="color: #E06C75">count</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">number</span><span style="color: #ABB2BF"> }&gt;();</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Response</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">({</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">results</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">total</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">res</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">count</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">};</span></span></code></pre>
</code></pre><p>而 <code>postComment</code> 就是直接往插入数据库插入一条记录：</p><pre><code class=language-ts><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">postComment</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">async</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">env</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">Env</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">content</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">string</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">nickname</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">string</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">uuid</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">crypto</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">randomUUID</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">createdAt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Date</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">toISOString</span><span style="color: #ABB2BF">();</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">await</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">env</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">DB</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">prepare</span><span style="color: #ABB2BF">(</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #98C379">`INSERT INTO Comments(id,createdAt,content,nickname) VALUES (?,?,?,?)`</span></span>
<span class=line><span style="color: #ABB2BF">  )</span></span>
<span class=line><span style="color: #ABB2BF">    .</span><span style="color: #61AFEF">bind</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">uuid</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">createdAt</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">content</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">nickname</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">    .</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">();</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Response</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">json</span><span style="color: #ABB2BF">({ </span><span style="color: #E06C75">message</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;ok&#39;</span><span style="color: #ABB2BF"> });</span></span>
<span class=line><span style="color: #ABB2BF">};</span></span></code></pre>
</code></pre><p>基本逻辑实现以后，可以在本地启动一个 Worker 的开发环境：</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">npx wrangler dev --local --persist</span></span></code></pre>
</code></pre><p>然后用 postman 之类的工具测试一下接口，如果你使用 Jetbrains IDE 的话可以创建一个 <code>test.http</code> 文件然后贴入下面的代码：</p><pre><code><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #abb2bf">###
GET http://127.0.0.1:8787/api/comments?page=1 HTTP/1.1
content-type: application/json

###
POST http://127.0.0.1:8787/api/comments HTTP/1.1
content-type: application/json

{
  &quot;content&quot;: &quot;test_content1&quot;,
  &quot;nickname&quot;: &quot;test&quot;
}</span></span></code></pre>
</code></pre><p>VSCode 可以通过安装 <a href=https://github.com/Huachao/vscode-restclient>REST Client</a> 插件来获得类似的功能，让你在编辑器里直接发送请求并查看结果。</p><h2 id=部署>部署</h2><p>部署的方式也非常简单，之前我们都是在本地测试的，首先去掉 local 这个 flag 来给线上的数据库创建表：</p><pre><code class=language-sh><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #ABB2BF">npx wrangler d1 execute &lt;DATABASE_NAME&gt; --file=./schema.sql</span></span></code></pre>
</code></pre><p>然后发布 Worker：</p><pre><code><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #abb2bf">npx wrangler publish</span></span></code></pre>
</code></pre><p>就完成了，然后可以把测试请求里的 URL 修改为 <code>&lt;YOUR_WORKER&gt;.&lt;YOUR_SUBDOMAIN&gt;.workers.dev</code> 重新测试一下。</p><h2 id=总结>总结</h2><p>Cloudflare Worker 和 D1 的结合使用，不止是给 Worker 提供了一个开箱即用的关系型数据库的存储方案，并且很大程度避免了边缘计算节点和传统的数据库服务跨数据中心通信的高延迟，实际上我觉得对于像评论系统，日常使用的一些机器人等等这样流量不大的各种应用来说，选择使用 Serverless 这样的技术来实现是非常好的一个选择，在开发体验上已经非常好，而且完全摆脱了日常的服务器维护成本。</p></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2023 zoubingwu. All rights reserved.</div></div></body></html>
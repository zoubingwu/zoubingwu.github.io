<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>关于promise的一些常见问题 | https://zoubingwu.com</title><meta property=og:title content="关于promise的一些常见问题 | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content=Promise让回调函数变成了规范的链式写法，程序流程可以看得很清楚。本文总结了一些刚开始使用时容易犯的常见错误。><meta property=og:description content=Promise让回调函数变成了规范的链式写法，程序流程可以看得很清楚。本文总结了一些刚开始使用时容易犯的常见错误。><link rel=canonical href=https://zoubingwu.com/2017-08-20/关于promise的一些常见问题><meta property=og:url content=https://zoubingwu.com/2017-08-20/关于promise的一些常见问题><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2017-08-20T17:15:22.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="关于promise的一些常见问题 | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    (i[r] =
      i[r] ||
      function () {
        (i[r].q = i[r].q || []).push(arguments);
      }),
      (i[r].l = 1 * new Date());
    (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m);
  })(
    window,
    document,
    'script',
    'https://www.google-analytics.com/analytics.js',
    'ga'
  );
  ga('create', 'UA-100363260-1', 'auto');
  ga('send', 'pageview');</script><script defer=defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "76b8468271b24f3180af2110f74841c3"}'></script></head><body><div class=content-container><div class=post><div class=post-title>关于promise的一些常见问题</div><span class=post-date><time>20 Aug 2017</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>promise</span></a></li><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>javascript</span></a></li></ul></div><h3 id=前言>前言</h3><p>Promise 是 一种 JavaScript 异步操作解决方案，让我们可以使用方便理解的正常的程序流程（同步），来处理异步操作。但新手刚开始使用这一特性的时候，经常会犯一些常见的错误，回顾自己以前的代码我发现有不少错误都是自己曾经犯过的。</p><p>我们来看看下面这几种promise写法的区别：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">()</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">doSomethingElse</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">finalHandler</span><span style="color: #ABB2BF">);;</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">()</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">doSomethingElse</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">finalHandler</span><span style="color: #ABB2BF">);;</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">()</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">doSomethingElse</span><span style="color: #ABB2BF">())</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">finalHandler</span><span style="color: #ABB2BF">);;</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">()</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">doSomethingElse</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">finalHandler</span><span style="color: #ABB2BF">);;</span></span></code></pre>
</code></pre><p>具体的区别我们稍后再细说，如果你觉得四种写法让你感到困惑了的话那么对于 promise 的理解恐怕还需要再加强一下。</p><h3 id=新手错误-1-then方法内部仍使用回调或嵌套then>新手错误 1: then方法内部仍使用回调或嵌套then</h3><p>我们可以看看下面的代码：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">remotedb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">allDocs</span><span style="color: #ABB2BF">({</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">include_docs</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">attachments</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">true</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">result</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">docs</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">rows</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">docs</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">forEach</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">element</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">localdb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">put</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">element</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">doc</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">response</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #61AFEF">alert</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Pulled doc with id &quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">element</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">doc</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">_id</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot; and added to local db.&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">err</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;conflict&#39;</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">localdb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">element</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">doc</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">_id</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">resp</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">          </span><span style="color: #E5C07B">localdb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">remove</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">resp</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">_id</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">resp</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">_rev</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">resp</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// et cetera...</span></span></code></pre>
</code></pre><p>习惯了回调函数的思路在刚接触到 promise 的时候很难去改变，虽然强迫了自己使用 promise，但在第一层 then 方法内部又开始继续使用回调函数或者嵌套的 then 调用，这样的代码非常的不 promisey，在阅读时也和之前的回调地狱一样，完全没有发挥 promise 的优势。我们可以改成下面这样的写法：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">remotedb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">allDocs</span><span style="color: #ABB2BF">(...).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">resultOfAllDocs</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">localdb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">put</span><span style="color: #ABB2BF">(...);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">resultOfPut</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">localdb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(...);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">resultOfGet</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">localdb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">put</span><span style="color: #ABB2BF">(...);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>这样子感受就好多了，这种写法被称为 composing promises 。这样可以带来清晰的代码结构，避免始料不及的错误。也可以快速的问题定位，避免难以调试更甚至于失败了而没有任何反馈。稍后我们还会详细说明。</p><h3 id=新手错误-2-then方法内使用foreach循环（或forwhile循环）进行异步操作>新手错误 2: then方法内使用forEach循环（或for/while循环）进行异步操作</h3><p>很多人可能会写出下面这样的代码：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// I want to remove() all docs</span></span>
<span class=line><span style="color: #E5C07B">db</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">allDocs</span><span style="color: #ABB2BF">({</span><span style="color: #E06C75">include_docs</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">result</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">rows</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">forEach</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">row</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">db</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">remove</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">row</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">doc</span><span style="color: #ABB2BF">);  </span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// I naively believe all docs have been removed() now!</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>问题出在哪里呢？第一个 then 方法可能没有等到循环内的异步操作结束就返回了一个 <code>undefined</code>，因此第二个 then 方法内并不确定所有的 remove 操作都完成了！这个时候我们就需要使用 <code>Promise.all</code> 了：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">db</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">allDocs</span><span style="color: #ABB2BF">({</span><span style="color: #E06C75">include_docs</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">result</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">all</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">rows</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">map</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">row</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">db</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">remove</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">row</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">doc</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }));</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">arrayOfResults</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// All docs have really been removed() now!</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>为了直观的感受，我们再来手写另一个简单的例子：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// 模拟一个异步的操作</span></span>
<span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">()</span></span>
<span class=line><span style="color: #ABB2BF">    })</span></span>
<span class=line><span style="color: #ABB2BF">  })</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 目标是异步打印数组内的每一个数，都完成后再打印done</span></span>
<span class=line><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">((</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">reject</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">arr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">]</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">arr</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">((</span><span style="color: #E06C75; font-style: italic">arr</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">arr</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">forEach</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">i</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  })</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;done&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">})</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 输出 done 1 2 3 4 5</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 结果很明显不是我们想要的</span></span></code></pre>
</code></pre><p>我们使用 <code>Promise.all</code> 来改写：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">arr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">]</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">arr</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">arr</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// 注意这里的两个return，为了演示更直观因此不使用箭头函数了</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// The Promise.all() method returns a single Promise that resolves when all of the promises in the iterable argument have resolved or when the iterable argument contains no promises. It rejects with the reason of the first promise that rejects.</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">all</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">arr</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">map</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">i</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  }))</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;done&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">})</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">//输出 1 2 3 4 5 done</span></span></code></pre>
</code></pre><p>Promise.all 方法用于将多个 Promise 实例，包装成一个新的 Promise 实例，它接受一个可遍历的对象作为参数，参数里的元素都是 Promise 对象的实例，参数内所有的都 resolve 以后它也会被 resolve，如果有一个被 reject，那么会同第一个被 reject 的 promise 实例一样被 reject，中文说起来有点绕，我们可以改写一下上面的例子：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">((</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">reject</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">setTimeout</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">||</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">reject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39; is not what I wanted&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      }</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">()</span></span>
<span class=line><span style="color: #ABB2BF">    })</span></span>
<span class=line><span style="color: #ABB2BF">  })</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 再次运行，结果为:</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 1</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 2</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 3</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 4</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 5</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 3 is not what I wanted</span></span></code></pre>
</code></pre><h3 id=新手错误-3-没有添加-catch>新手错误 3: 没有添加 .catch()</h3><p>这也是一个很常见的错误，很多人都会自信自己的代码不会抛出错误，或者就是忘记了添加 catch 方法，因此一旦运行出错后往往会给 debug 带来困难。如果实在不想费神去处理错误，其实简单的添加一句代码就够了：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">anotherPromise</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">yetAnotherPromise</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">error</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">bind</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">console</span><span style="color: #ABB2BF">));</span></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 可能有的公司不允许线上代码有console，可以视具体情况而定</span></span></code></pre>
</code></pre><h3 id=新手错误-4-使用-deferred>新手错误 4: 使用 deferred</h3><p>JavaScript 对于异步处理问题的历史很长，在promise还没有脱颖而出进入规范之前就有过许多的解决方案，jQuery 和 Angular 都使用过 &quot;deferred&quot; 模式，但现在已经被 ES6 的 Promise 规范所替代，因此最好不要再在自己的代码里使用了。更多的内容可以参考<a href=https://github.com/petkaantonov/bluebird/wiki/Promise-anti-patterns#the-deferred-anti-pattern>这篇文章</a></p><p>另外对于非 promise 化的 API，我们也可以很容易地使用 promise 来封装一层，比如基于回调函数的 nodejs 中的 <code>fs.readFile()</code> :</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">reject</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">fs</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">readFile</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;myfile.txt&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">file</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">reject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #7F848E; font-style: italic">/* ... */</span><span style="color: #ABB2BF">)</span></span></code></pre>
</code></pre><h3 id=新手错误-5-返回值的困惑>新手错误 5: 返回值的困惑</h3><p>看看下面的代码有什么问题：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">someOtherPromise</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// Gee, I hope someOtherPromise() has resolved!</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// Spoiler alert: it hasn&#39;t.</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>这是一个非常非常常见的问题，我刚开始完全搞不清楚，究竟哪里要return，哪里不要return，这里似乎不要return也能跑通？</p><p>所有的 promise 都有一个 then 方法，then 方法返回的应该是一个新的 promise 实例，这也是为什么我们能够使用链式写法。那在 then 方法内部，不同的返回值对后续链式有什么影响呢？</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// I&#39;m inside a then() function!</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>这里我们可以做三件事：</p><ol><li>返回另一个 promise</li><li>返回一个同步的值，或者 undefined</li><li>抛出一个同步的错误 我们来一一分析一下。</li></ol><h4 id=1返回另一个-promise>1.返回另一个 promise</h4><p>一个很常见的例子：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">getUserByName</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;nolan&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">user</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getUserAccountById</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">userAccount</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// I got a user account!</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>注意我们 return 了一个新的 promise，这个 return 非常关键，如果没有的话，在第二个 then 方法内就无法获得user.id，而是获得一个 undefined。</p><h4 id="2返回一个同步的值，或者-undefined">2.返回一个同步的值，或者 undefined</h4><p>return 一个undefined是一个很常见的错误，但返回一个同步的值可以把同步的代码转换成很 promisey 的代码。还是上面那个例子，我们假设可以从缓存中获取用户id：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">getUserByName</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;nolan&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">user</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">inMemoryCache</span><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">]) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">inMemoryCache</span><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">];    </span><span style="color: #7F848E; font-style: italic">// returning a synchronous value!</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getUserAccountById</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic">// returning a promise!</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">userAccount</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// I got a user account!</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>你可以看到，第二个 then 方法实际上并不在乎你是使用的异步还是同步的方式来获取的数据。但要小心的是，在js中一个函数如果没有return语句的话会默认return undefined，因此推荐在then方法内总是显式的使用return或者throw语句。</p><h4 id=3抛出一个同步的错误>3.抛出一个同步的错误</h4><p>这和上一条类似，比如我们在用户如果登出后抛出一个错误：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">getUserByName</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;nolan&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">user</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">isLoggedOut</span><span style="color: #ABB2BF">()) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">throw</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;user logged out!&#39;</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic">// throwing a synchronous error!</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">inMemoryCache</span><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">]) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">inMemoryCache</span><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">];       </span><span style="color: #7F848E; font-style: italic">// returning a synchronous value!</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getUserAccountById</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">);    </span><span style="color: #7F848E; font-style: italic">// returning a promise!</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">userAccount</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// I got a user account!</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// Boo, I got an error!</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>catch 方法会在用户登出或者某个promise被reject时接住错误，它也不会在乎这个错误到底是来自于同步或者异步的操作。这在我们开发时的某些时候还是很有用的，比如我们需要在then方法内解析一个JSON数据，它也许是不规范的，那么抛出的错误也可以被catch方法接住，而不像回调函数那样被吞掉了。</p><p>上面这些错误都是一些新手比较常见的，接下来说说一些稍微 &quot;高级&quot; 的问题。</p><h3 id=高级问题-1-不知道使用-promiseresolve>高级问题 1: 不知道使用 <code>Promise.resolve()</code></h3><p>之前我们已经学习了promise可以把同步的代码也包装成异步的，那么你可能会经常写出这样的代码：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">resolve</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">reject</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">someSynchronousValue</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #7F848E; font-style: italic">/* ... */</span><span style="color: #ABB2BF">)</span></span></code></pre>
</code></pre><p>其实你可以使用更简洁的写法：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">someSynchronousValue</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #7F848E; font-style: italic">/* ... */</span><span style="color: #ABB2BF">)</span></span></code></pre>
</code></pre><p>这样同步代码中的错误也可以被很好的处理，你可以很容易就通过这种方式来把一些同步的API转化成这种promise化的API：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">somePromiseAPI</span><span style="color: #ABB2BF">() {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">doSomethingThatMayThrow</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;foo&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  }).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #7F848E; font-style: italic">/* ... */</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #7F848E; font-style: italic">/* ... */</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>同步代码中抛出的错误都可能没有被正确处理，但使用 <code>Promise.resolve()</code> 来封装，总是可以使得错误被 <code>catch()</code> 方法接住。</p><p>类似的，<code>Promise.reject()</code> 可以用来返回一个马上被reject的promise。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">reject</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;some awful error&#39;</span><span style="color: #ABB2BF">));</span></span></code></pre>
</code></pre><h3 id=高级问题-2-catch其实就是thennull-的语法糖？>高级问题 2: catch()其实就是then(null, ...)的语法糖？</h3><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// handle error</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// handle error</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>上面这两个其实确实是等同的，但是我们来看看下面这样的：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">someOtherPromise</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// handle error</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">someOtherPromise</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// handle error</span></span>
<span class=line><span style="color: #ABB2BF">})</span></span></code></pre>
</code></pre><p>在我们使用 <code>then(resolveHandler, rejectHandler)</code>这样的格式的时候，<code>rejectHandler</code> 实际上负责的是前一个promise所抛出的错误，而不是由 <code>resolveHandler</code>所抛出的错误。因此，为了避免造成混淆，尽量不要使用then方法的第二个参数，而优先使用catch方法。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">throw</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;oh noes&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// I caught your error! :)</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">somePromise</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">throw</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;oh noes&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// I didn&#39;t catch your error! :(</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>除非是在编写一个必须抛出错误的异步 Mocha 测试用例时：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">it</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;should throw an error&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">doSomethingThatThrows</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">throw</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;I expected an error!&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  }, </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">err</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">should</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">exist</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">err</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><h3 id=高级问题-3-promises-vs-promise-factories>高级问题 3: promises vs promise factories</h3><p>我们有的时候需要执行一个连续的promise队列，但不像 <code>Promise.all</code> 一样是并行的，你可能会考虑用一个数组来循环迭代执行：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">executeSequentially</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">promises</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">promises</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">forEach</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">promise</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">promise</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>但实际上这个循环里的promise依然是并发执行的，因为promise一被创建就开始执行了，因此我们需要的是一个promise工厂函数来在需要的时候才创建promise：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">executeSequentially</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">promiseFactories</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">promiseFactories</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">forEach</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">promiseFactory</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">result</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">promiseFactory</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><h3 id=高级问题-4：依赖多个promise的结果>高级问题 4：依赖多个promise的结果</h3><p>一般来说我们都会依赖于上一个promise的结果，但有时候也可能会有依赖于多个promise结果的需求：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">getUserByName</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;nolan&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">user</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getUserAccountById</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">userAccount</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// dangit, I need the &quot;user&quot; object too!</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>我们可以把 user 用一个变量在外层作用域存放起来，但这样处理并不是那么优雅。</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #61AFEF">getUserByName</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;nolan&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">result</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">user</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">;</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getUserAccountById</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">userAccount</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// okay, I have both the &quot;user&quot; and the &quot;userAccount&quot;</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>或者干脆还是...使用嵌套的 then 方法...</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">getUserByName</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;nolan&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">user</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getUserAccountById</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">userAccount</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// okay, I have both the &quot;user&quot; and the &quot;userAccount&quot;</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>如果嵌套和缩进实在太多，就把函数抽出来放在具名函数里：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">onGetUserAndUserAccount</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">user</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">userAccount</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">userAccount</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">onGetUser</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">user</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getUserAccountById</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">user</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">id</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">userAccount</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">onGetUserAndUserAccount</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">userAccount</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #61AFEF">getUserByName</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;nolan&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">onGetUser</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #7F848E; font-style: italic">// at this point, doSomething() is done, and we are back to indentation 0</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><h3 id=高级问题-5-promise塌陷>高级问题 5: promise塌陷</h3><p>这个问题可能没那么常见，看看下面的代码：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;foo&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;bar&#39;</span><span style="color: #ABB2BF">))</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">result</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span></code></pre>
</code></pre><p>结果会是什么呢？它会打印 &#39;foo&#39;。</p><p>问题出在第一个then方法上，我们传入的其实并不是一个函数，而是一个已经resolve的对象，实际上上面的代码等价于：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;foo&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">result</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">  });</span></span></code></pre>
</code></pre><p>不过中间有多少个 <code>then(null)</code> ，它都会无视之而输出 foo，then方法应该接受一个函数作为参数才能实现我们想要的：</p><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;foo&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Promise</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">resolve</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;bar&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">result</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">result</span><span style="color: #ABB2BF">);</span></span>
<span class=line><span style="color: #ABB2BF">});</span></span></code></pre>
</code></pre><p>因此一定要记住，总是给then方法传入一个函数作为参数！</p><h3 id=最后>最后</h3><p>最后看到这里，我相信各位对开头的问题也都有了自己的理解。</p><h4 id=puzzle-1>Puzzle #1</h4><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">doSomethingElse</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">finalHandler</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>答案：</p><pre><code><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #abb2bf">doSomething
|-----------------|
                  doSomethingElse(undefined)
                  |------------------|
                                     finalHandler(resultOfDoSomethingElse)
                                     |------------------|</span></span></code></pre>
</code></pre><h4 id=puzzle-2>Puzzle #2</h4><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">doSomethingElse</span><span style="color: #ABB2BF">();</span></span>
<span class=line><span style="color: #ABB2BF">}).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">finalHandler</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>答案：</p><pre><code><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #abb2bf">doSomething
|-----------------|
                  doSomethingElse(undefined)
                  |------------------|
                  finalHandler(undefined)
                  |------------------|</span></span></code></pre>
</code></pre><h4 id=puzzle-3>Puzzle #3</h4><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">doSomethingElse</span><span style="color: #ABB2BF">())</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">finalHandler</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>答案：</p><pre><code><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #abb2bf">doSomething
|-----------------|
doSomethingElse(undefined)
|---------------------------------|
                  finalHandler(resultOfDoSomething)
                  |------------------|</span></span></code></pre>
</code></pre><h4 id=puzzle-4>Puzzle #4</h4><pre><code class=language-js><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #61AFEF">doSomething</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">doSomethingElse</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  .</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">finalHandler</span><span style="color: #ABB2BF">);</span></span></code></pre>
</code></pre><p>答案：</p><pre><code><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #abb2bf">doSomething
|-----------------|
                  doSomethingElse(resultOfDoSomething)
                  |------------------|
                                     finalHandler(resultOfDoSomethingElse)
                                     |------------------|</span></span></code></pre>
</code></pre><p>最后可以查看这个<a href=http://jsbin.com/tuqukakawo/1/edit?js,console,output>JSBin</a>看看效果。</p><p>ref:</p><ul><li><a href=http://javascript.ruanyifeng.com/advanced/promise.html#toc9>http://javascript.ruanyifeng.com/advanced/promise.html#toc9</a></li><li><a href=https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html>https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html</a></li><li><a href=http://imweb.io/topic/57a0760393d9938132cc8da9>http://imweb.io/topic/57a0760393d9938132cc8da9</a></li></ul></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2023 zoubingwu. All rights reserved.</div></div></body></html>
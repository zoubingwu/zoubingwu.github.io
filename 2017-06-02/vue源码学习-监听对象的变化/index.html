<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta name=keywords content=blog,html,css,javascript,react,vue,nodejs><meta name=description content="zoubingwu 个人博客, zoubingwu's blog"><link href=/assets/images/favicon.ico rel=bookmark type=image/x-icon><link href=/assets/images/favicon.ico rel=icon type=image/x-icon><link href=/assets/images/favicon.ico rel="shortcut icon" type=image/x-icon><link rel=stylesheet href=/assets/css/main.css type=text/css><link rel=preload href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css as=style><link rel=preload href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.6.0/style.css><link rel=alternate type=application/rss+xml title="RSS Feed for zoubingwu's blog" href=/feed.xml><title>Vue源码学习-监听对象的变化 | https://zoubingwu.com</title><meta property=og:title content="Vue源码学习-监听对象的变化 | https://zoubingwu.com"><meta property=og:locale content=en_US><meta name=description content=最近一直恶补一些计算机基础的东西，顺便研究了一下vue的核心思路...><meta property=og:description content=最近一直恶补一些计算机基础的东西，顺便研究了一下vue的核心思路...><link rel=canonical href=https://zoubingwu.com/2017-06-02/vue源码学习-监听对象的变化><meta property=og:url content=https://zoubingwu.com/2017-06-02/vue源码学习-监听对象的变化><meta property=og:site_name content="zoubingwu's blog"><meta property=og:type content=article><meta property=article:published_time content=2017-06-02T11:15:27.000Z><meta name=twitter:card content=summary><meta property=twitter:title content="Vue源码学习-监听对象的变化 | https://zoubingwu.com"><script>(function (i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r]
  || function () { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 *
  new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]);
  a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document,
  'script', 'https://www.google-analytics.com/analytics.js', 'ga' );
  ga('create', 'UA-100363260-1', 'auto'); ga('send', 'pageview');</script><script defer=defer data-domain=zoubingwu.com src=https://plausible.io/js/script.js></script></head><body><div class=content-container><div class=post><div class=post-title>Vue源码学习-监听对象的变化</div><span class=post-date><time>2 Jun 2017</time></span><div class=post-tag><ul><li><a><span><i class="fa fa-paperclip" aria-hidden=true></i>vue</span></a></li></ul></div><p>Vue的源码直接看起来还是很费劲，还好这方面的资料也很多。这篇文章写写Vue最基本的核心 — 基于<code>Object.defineProperty</code>对<code>getter</code>和<code>setter</code>函数的劫持，实现对数据变化的监听。</p><p>思路其实是很容易理解的，通过自定义访问器属性中的<code>getter</code> 和<code>setter</code>函数来实现对属性的监听。</p><p>提到<code>getter</code>和<code>setter</code>就要说一说对象的访问器属性和数据属性，数据属性只有基本的四个特性：</p><ol><li>[[configurable]] 可配置</li><li>[[enumerable]] 可枚举</li><li>[[writable]] 可写</li><li>[[value]] 值</li></ol><p>当访问这一属性是，可以直接获取到<code>[[value]]</code>的值，同理修改时也是修改的这一值。而不同于数据属性，访问器的四个属性则是：</p><ol><li>[[configurable]]</li><li>[[enumerable]]</li><li>[[getter]]</li><li>[[setter]]</li></ol><p>通过get和set方法来获取和修改值，在JS中我们可以直接通过<code>Object.defineProperty</code>这一接口来自定义这两个方法以达成监听的目的：</p><pre><code class=language-javascript><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// 最简单的情况，针对值为简单类型的属性</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">person</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;jack&#39;</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #E5C07B">person</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">listen</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">property</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">val</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">property</span><span style="color: #ABB2BF">]</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">Object</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">defineProperty</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;name&#39;</span><span style="color: #ABB2BF">, {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;oops someone is trying to get the value&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">val</span></span>
<span class=line><span style="color: #ABB2BF">    },</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">set</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">newVal</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;ok the name now has been changed to &#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">newVal</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E06C75">val</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">newVal</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line><span style="color: #ABB2BF">  })</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span></code></pre>
</code></pre><p>可以看下面的GIF查看效果：</p><p><img src=/assets/images/2017-06-03-Vue%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-%E7%9B%91%E5%90%AC%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%95%B0%E7%BB%84%E7%9A%84%E5%8F%98%E5%8C%96/1.gif alt=gif></p><p>但是如果name的值是一个对象，修改这个对象中的值并不会改变 name所保存的对象引用，因此也就无法达成监听的目的，解决的方法就是利用递归算法：</p><pre><code class=language-javascript><pre class=shiki style="background-color: #282c34"><code><span class=line><span style="color: #7F848E; font-style: italic">// 将数据多包装一层</span></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Observer</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">data</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">data</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">iterate</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 遍历每一个属性</span></span>
<span class=line><span style="color: #E5C07B">Observer</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">prototype</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">iterate</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">obj</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">val</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">obj</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">val</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">obj</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">]</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// 如果属性对应的值为对象，继续递归遍历</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">typeof</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">val</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;object&#39;</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Observer</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">val</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// 监听属性</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">listen</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">val</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #7F848E; font-style: italic">// 监听属性函数</span></span>
<span class=line><span style="color: #E5C07B">Observer</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">prototype</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">listen</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">key</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">value</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E5C07B">Object</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">defineProperty</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">, {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> () {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;oops someone is trying to get the value of &#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">value</span></span>
<span class=line><span style="color: #ABB2BF">    },</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">set</span><span style="color: #ABB2BF">: </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75; font-style: italic">newVal</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;ok the &#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39; now has been changed to &#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">newVal</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #7F848E; font-style: italic">// 如果值设置为了新的对象，重新遍历监听</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">typeof</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">newVal</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">===</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;object&#39;</span><span style="color: #ABB2BF">) {</span></span>
<span class=line><span style="color: #ABB2BF">        </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Observer</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">newVal</span><span style="color: #ABB2BF">)</span></span>
<span class=line><span style="color: #ABB2BF">      }</span></span>
<span class=line><span style="color: #ABB2BF">      </span><span style="color: #E06C75">value</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">newVal</span></span>
<span class=line><span style="color: #ABB2BF">    }</span></span>
<span class=line><span style="color: #ABB2BF">  })</span></span>
<span class=line><span style="color: #ABB2BF">}</span></span>
<span class=line></span>
<span class=line><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">person</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Observer</span><span style="color: #ABB2BF">({</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;jack&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">age</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">25</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">  </span><span style="color: #E06C75">info</span><span style="color: #ABB2BF">: {</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">prof</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;teacher&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class=line><span style="color: #ABB2BF">    </span><span style="color: #E06C75">city</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;beijng&#39;</span></span>
<span class=line><span style="color: #ABB2BF">  }</span></span>
<span class=line><span style="color: #ABB2BF">})</span></span></code></pre>
</code></pre><p>结果如图：</p><p><img src=/assets/images/2017-06-03-Vue%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0-%E7%9B%91%E5%90%AC%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%95%B0%E7%BB%84%E7%9A%84%E5%8F%98%E5%8C%96/2.gif alt=gif></p><p>下一篇我们说说如何监听一个数组的问题。</p></div><div class=footer><hr><div class=footer-link><a href=/archive><i class="fa fa-archive" aria-hidden=true></i></a><a target=_blank href=https://twitter.com/chow_won><i class="fa fa-twitter" aria-hidden=true></i></a> <a target=_blank href=https://github.com/zoubingwu><i class="fa fa-github" aria-hidden=true></i></a> <a target=_blank href=mailto:zoubingwu@gmail.com><i class="fa fa-envelope" aria-hidden=true></i></a></div>© 2016-2023 zoubingwu. All rights reserved.</div></div></body></html>